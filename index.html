<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultimate Toddler Color Adventure</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7640229859579036"
     crossorigin="anonymous"></script>
  <style>
    /* Core Styles */
    :root {
      --primary-color: #a259f7;
      --secondary-color: #ff4b5c;
      --accent-color: #ffe34b;
      --background-start: #f7e9ff;
      --background-end: #ffe34b;
      --text-color: #333;
      --btn-color: #fffbe7;
      --shadow-color: rgba(0,0,0,0.15);
      --transition-speed: 0.3s;
      --border-radius: 20px;
    }

    * {
      box-sizing: border-box;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
      background-size: 400% 400%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
      animation: bgmove 10s ease infinite alternate;
      color: var(--text-color);
    }

    @keyframes bgmove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .hidden {
      display: none !important;
    }

    .main-container {
      width: 100%;
      max-width: 1200px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    /* Header Styles */
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      z-index: 10;
    }

    .game-title {
      color: var(--primary-color);
      font-size: 2.7em;
      text-shadow: 2px 2px 8px #fff, 0 0 10px var(--primary-color);
      letter-spacing: 2px;
      margin: 0;
      transition: transform 0.3s;
    }

    .game-title:hover {
      transform: scale(1.05);
    }

    .menu-button {
      background: var(--accent-color);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      cursor: pointer;
      box-shadow: 0 4px 10px var(--shadow-color);
      transition: all 0.2s;
    }

    .menu-button:hover {
      transform: scale(1.1);
    }

    .menu-button:active {
      transform: scale(0.95);
    }

    /* Menu Styles */
    .game-menu {
      position: absolute;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 20px var(--shadow-color);
      z-index: 100;
      padding: 40px 20px;
      transition: left 0.3s ease;
      overflow-y: auto;
    }

    .game-menu.active {
      left: 0;
    }

    .menu-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
    }

    .menu-title {
      font-size: 1.5em;
      margin-bottom: 30px;
      color: var(--primary-color);
      text-align: center;
    }

    .menu-item {
      padding: 12px 15px;
      margin-bottom: 10px;
      background: var(--btn-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.1em;
      text-align: center;
      box-shadow: 0 2px 5px var(--shadow-color);
      display: flex;
      align-items: center;
    }

    .menu-item:hover {
      background: var(--accent-color);
      transform: translateX(5px);
    }

    .menu-item-icon {
      margin-right: 15px;
      font-size: 1.2em;
    }

    /* Game Modes Container */
    .game-modes {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px 0;
    }

    .mode-card {
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--border-radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px var(--shadow-color);
      padding: 20px;
      border: 3px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .mode-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 25px var(--shadow-color);
      border: 3px solid var(--primary-color);
    }

    .mode-card:active {
      transform: scale(0.95);
    }

    .mode-icon {
      font-size: 3em;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .mode-card:hover .mode-icon {
      transform: scale(1.2) rotate(10deg);
    }

    .mode-title {
      font-size: 1.3em;
      text-align: center;
      color: var(--primary-color);
      font-weight: bold;
    }

    .mode-description {
      font-size: 0.9em;
      text-align: center;
      color: var(--text-color);
      margin-top: 10px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .mode-card:hover .mode-description {
      opacity: 1;
    }

    /* Game Content Containers */
    .game-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      overflow: hidden;
    }

    .mode-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      transform: translateX(100%);
    }

    .mode-container.active {
      opacity: 1;
      pointer-events: all;
      transform: translateX(0);
    }

    /* Classic Mode */
    .categories {
      display: flex;
      gap: 18px;
      margin-bottom: 28px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .category-btn {
      background: var(--btn-color);
      border: 2px solid var(--primary-color);
      border-radius: 18px;
      padding: 12px 28px;
      font-size: 1.3em;
      color: var(--primary-color);
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(162, 89, 247, 0.1);
    }

    .category-btn.active, .category-btn:active {
      background: var(--accent-color);
      color: var(--secondary-color);
      border: 2px solid var(--secondary-color);
      transform: scale(1.05);
    }

    .buttons {
      display: flex;
      gap: 28px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 90vw;
    }

    .color-btn {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      border: none;
      font-size: 2em;
      color: white;
      cursor: pointer;
      box-shadow: 0 8px 24px var(--shadow-color);
      transition: transform 0.15s, box-shadow 0.15s;
      animation: pulse 1.5s infinite;
      position: relative;
      z-index: 1;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .color-btn:active {
      transform: scale(1.18) rotate(-8deg);
      box-shadow: 0 0 40px 10px rgba(255, 255, 255, 0.4);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    /* Home Screen */
    .welcome-screen {
      text-align: center;
      padding: 40px;
    }

    .welcome-title {
      font-size: 2.8em;
      color: var(--primary-color);
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .welcome-subtitle {
      font-size: 1.5em;
      margin-bottom: 40px;
      color: var(--text-color);
    }

    .start-btn {
      background: var(--primary-color);
      border: none;
      border-radius: var(--border-radius);
      padding: 15px 30px;
      font-size: 1.5em;
      color: white;
      cursor: pointer;
      box-shadow: 0 5px 15px var(--shadow-color);
      transition: all 0.2s;
      margin-top: 20px;
    }

    .start-btn:hover {
      transform: scale(1.1);
      background: var(--secondary-color);
    }

    .start-btn:active {
      transform: scale(0.95);
    }

    /* Navigation */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      width: 100%;
      padding: 0 20px;
      margin-top: 20px;
    }

    .nav-btn {
      background: var(--primary-color);
      border: none;
      border-radius: var(--border-radius);
      padding: 10px 20px;
      font-size: 1.2em;
      color: white;
      cursor: pointer;
      box-shadow: 0 5px 15px var(--shadow-color);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover {
      transform: scale(1.05);
      background: var(--secondary-color);
    }

    .nav-btn:active {
      transform: scale(0.95);
    }

    .nav-btn-icon {
      margin-right: 10px;
    }

    /* Overlay and Effects */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 90;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .game-title {
        font-size: 2.2em;
      }
      
      .game-modes {
        gap: 15px;
      }
      
      .mode-card {
        width: 150px;
        height: 150px;
      }
      
      .color-btn {
        width: 90px;
        height: 90px;
        font-size: 1.6em;
        margin: 8px;
      }
      
      .category-btn {
        padding: 10px 20px;
        font-size: 1.1em;
        margin: 5px;
      }
    }

    @media (max-width: 480px) {
      .game-title {
        font-size: 1.8em;
      }
      
      .mode-card {
        width: 130px;
        height: 130px;
      }
      
      .mode-icon {
        font-size: 2em;
      }
      
      .mode-title {
        font-size: 1em;
      }
      
      .color-btn {
        width: 75px;
        height: 75px;
        font-size: 1.3em;
        margin: 5px;
      }
      
      .category-btn {
        padding: 8px 16px;
        font-size: 0.9em;
      }
    }

    /* Quiz Mode Styles */
    .quiz-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }

    .quiz-question {
      font-size: 1.6em;
      margin-bottom: 30px;
      text-align: center;
      color: var(--primary-color);
      font-weight: bold;
    }

    .quiz-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .quiz-option {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 2em;
      box-shadow: 0 5px 15px var(--shadow-color);
    }

    .quiz-option:hover {
      transform: scale(1.1);
    }

    .quiz-option.correct {
      border-color: green;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }

    .quiz-option.incorrect {
      border-color: red;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    }

    .quiz-score {
      font-size: 1.4em;
      margin-bottom: 20px;
    }

    .quiz-progress {
      width: 80%;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 30px;
    }

    .quiz-progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      transition: width 0.5s;
    }

    /* Paint Mode Styles */
    .paint-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      padding: 20px;
    }

    .paint-toolbar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .color-palette {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .palette-color {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
      border: 2px solid transparent;
    }

    .palette-color:hover {
      transform: scale(1.2);
    }

    .palette-color.selected {
      border-color: var(--text-color);
      transform: scale(1.2);
    }

    .paint-actions {
      display: flex;
      gap: 10px;
    }

    .paint-btn {
      background: var(--btn-color);
      border: none;
      border-radius: 10px;
      padding: 8px 15px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.9em;
    }

    .paint-btn:hover {
      background: var(--accent-color);
    }

    .canvas-container {
      flex: 1;
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #paint-canvas {
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    /* Decorated Edges */
    .decorated-edge {
      position: absolute;
      pointer-events: none;
      z-index: 5;
    }

    .edge-top-left {
      top: 0;
      left: 0;
      font-size: 3em;
    }

    .edge-top-right {
      top: 0;
      right: 0;
      font-size: 3em;
    }

    .edge-bottom-left {
      bottom: 0;
      left: 0;
      font-size: 3em;
    }

    .edge-bottom-right {
      bottom: 0;
      right: 0;
      font-size: 3em;
    }

    /* Floating Animation Elements */
    .floating-element {
      position: absolute;
      pointer-events: none;
      z-index: 2;
      animation: float 8s ease-in-out infinite, spin 15s linear infinite;
      opacity: 0.5;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); }
      25% { transform: translateY(-15px) translateX(10px); }
      50% { transform: translateY(0) translateX(25px); }
      75% { transform: translateY(15px) translateX(10px); }
    }

    /* Success/Error Animations */
    @keyframes success-pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
      50% { transform: scale(1.1); box-shadow: 0 0 20px 10px rgba(0, 255, 0, 0.5); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
    }

    @keyframes error-shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-10px); }
      40%, 80% { transform: translateX(10px); }
    }

    /* Loading Animation */
    .loading-animation {
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .loading-animation.active {
      opacity: 1;
      pointer-events: all;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 6px solid transparent;
      border-top-color: var(--primary-color);
      border-bottom-color: var(--secondary-color);
      animation: spinner 1.5s linear infinite;
    }

    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Story Mode Styles */
    .story-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }

    .story-image {
      width: 90%;
      max-width: 500px;
      height: 250px;
      background: white;
      border-radius: 20px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: 0 5px 15px var(--shadow-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
    }

    .story-text {
      font-size: 1.3em;
      text-align: center;
      margin-bottom: 30px;
      line-height: 1.5;
      color: var(--text-color);
    }

    .story-actions {
      display: flex;
      gap: 20px;
    }

    .story-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.1em;
    }

    .story-btn:hover {
      background: var(--secondary-color);
      transform: scale(1.05);
    }

    /* Enhanced Animations */
    .bounce-animation {
      animation: bounce 2s infinite;
    }

    .pulse-animation {
      animation: pulse 1.5s infinite;
    }

    .spin-animation {
      animation: spin 1s linear;
    }

    /* Toddler-friendly UI */
    .big-emoji {
      font-size: 4em;
      margin-bottom: 15px;
    }

    /* Progress Bar */
    .progress-container {
      width: 100%;
      margin: 20px 0;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .progress-bar {
      height: 12px;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: 6px;
      transition: width 0.5s;
    }

    /* Star Animation */
    .star {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 200px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease-out;
      z-index: 100;
      filter: drop-shadow(0 0 20px rgba(255, 255, 0, 0.8));
    }

    .star.show {
      transform: translate(-50%, -50%) scale(1.2);
      opacity: 1;
      animation: starBurst 0.9s ease-out;
    }

    @keyframes starBurst {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }

    /* Confetti Animation */
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 99;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 20px;
      background: #d13447;
      opacity: 0;
      animation: confettiFall 1.5s ease-out forwards;
    }

    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(300px) rotate(360deg); opacity: 0; }
    }

    /* Color Popup */
    .color-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: white;
      border-radius: 30px;
      padding: 40px 60px;
      font-size: 3em;
      font-weight: bold;
      font-family: 'Comic Sans MS', 'Baloo 2', cursive, sans-serif;
      box-shadow: 0 8px 32px var(--shadow-color);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      text-align: center;
      border: 4px solid var(--accent-color);
      transition: all 0.3s;
    }

    .color-popup.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      animation: popIn 0.4s ease-out;
    }

    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .popup-emoji {
      font-size: 1.5em;
      margin-right: 20px;
      vertical-align: middle;
    }

    /* 3D Effect Buttons */
    .color-btn {
      transform-style: preserve-3d;
      transition: transform 0.1s, box-shadow 0.1s;
      border: none;
      position: relative;
    }

    .color-btn::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 50%;
      transform: translateZ(-5px);
      bottom: -5px;
      left: 0;
      z-index: -1;
    }

    /* Rainbow Text for Titles */
    .rainbow-text {
      background: linear-gradient(to right, #ff4b5c, #ffb347, #ffe34b, #4be37a, #4bafff, #a259f7);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: rainbow-move 5s linear infinite;
      background-size: 200% auto;
    }

    @keyframes rainbow-move {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    /* Enhanced Confetti */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* More Confetti Shapes */
    .confetti-square {
      width: 12px;
      height: 12px;
    }

    .confetti-circle {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .confetti-triangle {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 16px solid;
      background: transparent !important;
    }
    
    /* Button Press Effects */
    .button-press {
      transform: scale(0.95);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    /* Special Effects */
    .glow-effect {
      box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.8);
      animation: glowing 2s infinite;
    }

    @keyframes glowing {
      0%, 100% { box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.8); }
      50% { box-shadow: 0 0 25px 10px rgba(255, 255, 255, 0.5); }
    }

    /* Sparkle Effect */
    .sparkle {
      position: absolute;
      pointer-events: none;
      background: white;
      border-radius: 50%;
      mix-blend-mode: screen;
      opacity: 0;
    }

    .sparkle-sm {
      width: 8px;
      height: 8px;
      animation: sparkle-sm 600ms ease-in-out;
    }

    .sparkle-md {
      width: 12px;
      height: 12px;
      animation: sparkle-md 800ms ease-in-out;
    }

    .sparkle-lg {
      width: 16px;
      height: 16px;
      animation: sparkle-lg 1000ms ease-in-out;
    }

    @keyframes sparkle-sm {
      0% { transform: scale(0); opacity: 0; }
      20% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(0); opacity: 0; }
    }

    @keyframes sparkle-md {
      0% { transform: scale(0); opacity: 0; }
      20% { transform: scale(1); opacity: 0.9; }
      100% { transform: scale(0); opacity: 0; }
    }

    @keyframes sparkle-lg {
      0% { transform: scale(0); opacity: 0; }
      20% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0); opacity: 0; }
    }
    
    /* Match Mode Styles */
    .match-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .match-header {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    
    .match-score, .match-timer {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .match-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      max-width: 600px;
      margin-bottom: 30px;
    }
    
    .match-card {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 15px;
      background: white;
      box-shadow: 0 4px 10px var(--shadow-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      cursor: pointer;
      transform-style: preserve-3d;
      transition: transform 0.6s;
      position: relative;
    }
    
    .match-card.flipped {
      transform: rotateY(180deg);
    }
    
    .match-card-front, .match-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .match-card-front {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      font-size: 0.8em;
      color: white;
    }
    
    .match-card-back {
      transform: rotateY(180deg);
    }
    
    .match-controls {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    
    .match-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .match-btn:hover {
      background: var(--secondary-color);
    }
    
    .match-level {
      padding: 10px;
      border-radius: var(--border-radius);
      border: 2px solid var(--primary-color);
      font-family: inherit;
      font-size: 1em;
      cursor: pointer;
    }
    
    /* Dance Mode Styles */
    .dance-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .dance-stage {
      width: 90%;
      max-width: 600px;
      height: 300px;
      background: linear-gradient(to bottom, #f7e9ff, #ffe34b);
      border-radius: 20px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 5px 15px var(--shadow-color);
    }
    
    .dancer {
      position: absolute;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 5em;
      transition: all 0.3s;
    }
    
    .dance-animation {
      animation: dance 2s ease-in-out;
    }
    
    @keyframes dance {
      0%, 100% { transform: translateX(-50%) rotate(0deg); }
      25% { transform: translateX(-60%) rotate(-20deg) scale(1.1); }
      50% { transform: translateX(-50%) rotate(0deg) translateY(-30px); }
      75% { transform: translateX(-40%) rotate(20deg) scale(1.1); }
    }
    
    .dance-color-picker {
      width: 90%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .dance-instruction {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .dance-colors {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    
    .dance-color {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 3px 8px var(--shadow-color);
      transition: transform 0.2s;
    }
    
    .dance-color:hover {
      transform: scale(1.1);
    }
    
    .dance-controls {
      display: flex;
      gap: 20px;
    }
    
    .dance-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .dance-btn:hover {
      background: var(--secondary-color);
    }
    
    /* Peek-a-boo Mode Styles */
    .peekaboo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .peekaboo-score {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .peekaboo-stage {
      width: 90%;
      max-width: 600px;
      height: 400px;
      background: #f5f5f5;
      border-radius: 20px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 5px 15px var(--shadow-color);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .peekaboo-instruction {
      font-size: 1.5em;
      color: var(--primary-color);
      text-align: center;
      padding: 0 20px;
    }
    
    .peekaboo-item {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      cursor: pointer;
      box-shadow: 0 3px 8px var(--shadow-color);
      transition: all 0.2s;
      opacity: 0;
    }
    
    .peekaboo-item.visible {
      opacity: 1;
    }
    
    .peekaboo-item.found {
      animation: found-animation 0.5s forwards;
    }
    
    @keyframes found-animation {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(0); opacity: 0; }
    }
    
    .peekaboo-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .peekaboo-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .peekaboo-btn:hover {
      background: var(--secondary-color);
    }
    
    .peekaboo-difficulty {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .peekaboo-speed-btn {
      background: var(--btn-color);
      border: none;
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .peekaboo-speed-btn.active {
      background: var(--accent-color);
      font-weight: bold;
    }
    
    /* Game Completion Message */
    .game-completion-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 30px var(--shadow-color);
      z-index: 50;
    }
    
    .completion-title {
      font-size: 2em;
      color: var(--primary-color);
      margin-bottom: 15px;
      font-weight: bold;
    }
    
    .completion-details {
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    
    .completion-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .completion-btn:hover {
      background: var(--secondary-color);
      transform: scale(1.05);
    }
    
    /* Count Mode Styles */
    .count-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .count-header {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .count-score {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .count-stage {
      width: 90%;
      max-width: 600px;
      height: 300px;
      background: white;
      border-radius: 20px;
      margin-bottom: 30px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 5px 15px var(--shadow-color);
      position: relative;
    }
    
    .count-question {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: var(--primary-color);
      text-align: center;
    }
    
    .count-objects {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 20px;
      height: 200px;
    }
    
    .count-object {
      font-size: 4em;
      animation: float 3s ease-in-out infinite;
      transition: transform 0.2s;
    }
    
    .count-object:hover {
      transform: scale(1.2);
    }
    
    .count-answer {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .count-number-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      background: var(--primary-color);
      color: white;
      font-size: 2em;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 10px var(--shadow-color);
    }
    
    .count-number-btn:hover {
      transform: scale(1.1);
      background: var(--secondary-color);
    }
    
    .count-controls {
      display: flex;
      justify-content: center;
    }
    
    .count-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: var(--border-radius);
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 10px var(--shadow-color);
    }
    
    .count-btn:hover {
      background: var(--secondary-color);
      transform: scale(1.05);
    }
    
    .count-feedback {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 5em;
      opacity: 0;
      pointer-events: none;
    }
    
    .count-feedback.show {
      animation: feedback-animation 1s forwards;
    }
    
    @keyframes feedback-animation {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
    }
    
    /* Bubbles Mode Styles */
    .bubbles-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .bubbles-score {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .bubbles-stage {
      width: 90%;
      max-width: 800px;
      height: 400px;
      background: linear-gradient(to bottom, #c7eeff, #81d4fa);
      border-radius: 20px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 5px 15px var(--shadow-color);
    }
    
    .bubble {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      animation-name: float-bubble;
      animation-timing-function: ease-in-out;
      animation-iteration-count: infinite;
      box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.8), 0 0 15px rgba(255, 255, 255, 0.5);
      transition: transform 0.1s;
    }
    
    .bubble::before {
      content: '';
      position: absolute;
      width: 20%;
      height: 20%;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      top: 20%;
      left: 20%;
      filter: blur(2px);
    }
    
    .bubble:hover {
      transform: scale(1.05);
    }
    
    .bubble.popping {
      animation: pop-bubble 0.3s forwards;
    }
    
    @keyframes float-bubble {
      0% { transform: translateY(0) translateX(0); }
      50% { transform: translateY(-20px) translateX(10px); }
      100% { transform: translateY(0) translateX(0); }
    }
    
    @keyframes pop-bubble {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(0); opacity: 0; }
    }
    
    .bubbles-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .bubbles-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: var(--border-radius);
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .bubbles-btn:hover {
      background: var(--secondary-color);
      transform: scale(1.05);
    }
    
    .bubbles-options {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .bubbles-amount-btn {
      background: var(--btn-color);
      border: none;
      padding: 5px 15px;
      border-radius: 10px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .bubbles-amount-btn.active {
      background: var(--accent-color);
      font-weight: bold;
    }
    
    /* Shapes Mode Styles */
    .shapes-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .shapes-header {
      margin-bottom: 30px;
    }
    
    .shapes-title {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
    }
    
    .shapes-board {
      width: 90%;
      max-width: 800px;
      min-height: 400px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px var(--shadow-color);
    }
    
    .shape-item {
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: transform 0.3s;
    }
    
    .shape-item:hover {
      transform: scale(1.1);
    }
    
    .shape-item svg {
      width: 100%;
      height: 100%;
    }
    
    .shape-name {
      position: absolute;
      bottom: -25px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.9em;
      color: var(--text-color);
    }
    
    .shapes-controls {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .shapes-selector {
      display: flex;
      gap: 10px;
    }
    
    .shape-type-btn {
      background: var(--btn-color);
      border: none;
      padding: 8px 15px;
      border-radius: 15px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .shape-type-btn.active {
      background: var(--accent-color);
      font-weight: bold;
    }
    
    /* Music Mode Styles */
    .music-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .music-header {
      margin-bottom: 20px;
    }
    
    .music-title {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
    }
    
    .music-stage {
      width: 90%;
      max-width: 600px;
      height: 200px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px var(--shadow-color);
      overflow: hidden;
    }
    
    .music-instrument {
      font-size: 8em;
      transition: all 0.3s;
    }
    
    .music-instrument.playing {
      animation: instrument-play 0.5s ease-in-out;
    }
    
    @keyframes instrument-play {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .music-keys {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      width: 90%;
      max-width: 600px;
    }
    
    .music-key {
      width: 80px;
      height: 80px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5em;
      box-shadow: 0 5px 10px var(--shadow-color);
      transition: all 0.2s;
    }
    
    .music-key:hover {
      transform: scale(1.05);
    }
    
    .music-key:active, .music-key.active {
      transform: scale(0.95);
      box-shadow: 0 2px 5px var(--shadow-color);
    }
    
    .music-controls {
      display: flex;
      gap: 20px;
    }
    
    .music-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .music-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }
    
    /* Seasons Mode Styles */
    .seasons-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 20px;
    }
    
    .seasons-header {
      margin-bottom: 20px;
    }
    
    .seasons-title {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
    }
    
    .seasons-display {
      width: 90%;
      max-width: 700px;
      height: 400px;
      background: white;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px var(--shadow-color);
      position: relative;
      overflow: hidden;
    }
    
    .season-scene {
      width: 100%;
      height: 100%;
      position: relative;
      transition: background 1s ease;
    }
    
    .season-item {
      position: absolute;
      transition: all 0.5s;
      cursor: pointer;
    }
    
    .season-item:hover {
      transform: scale(1.1);
    }
    
    .season-name {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 2em;
      color: white;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      background: rgba(0, 0, 0, 0.3);
      padding: 10px 0;
    }
    
    .seasons-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    
    .season-btn {
      background: var(--btn-color);
      border: none;
      padding: 10px 20px;
      border-radius: 15px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 3px 8px var(--shadow-color);
    }
    
    .season-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px var(--shadow-color);
    }
    
    .season-btn.active {
      background: var(--accent-color);
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Decorated Edges -->
    <div class="decorated-edge edge-top-left">üåü</div>
    <div class="decorated-edge edge-top-right">ü¶ã</div>
    <div class="decorated-edge edge-bottom-left">üåà</div>
    <div class="decorated-edge edge-bottom-right">ü¶Ñ</div>
    
    <!-- Floating Elements -->
    <div class="floating-element" style="top: 20%; left: 10%;">üåº</div>
    <div class="floating-element" style="top: 15%; left: 80%;">üåµ</div>
    <div class="floating-element" style="top: 70%; left: 15%;">üç≠</div>
    <div class="floating-element" style="top: 65%; left: 85%;">üéà</div>
    
    <!-- Loading Animation -->
    <div class="loading-animation" id="loading-animation">
      <div class="spinner"></div>
    </div>
    
    <!-- Header -->
    <div class="game-header">
      <h1 class="game-title">Color Adventure</h1>
      <button class="menu-button" id="menu-toggle">‚â°</button>
    </div>
    
    <!-- Menu Panel -->
    <div class="game-menu" id="game-menu">
      <button class="menu-close" id="menu-close">‚úï</button>
      <h2 class="menu-title">Menu</h2>
      <div class="menu-item" data-action="home">
        <span class="menu-item-icon">üè†</span> Home
      </div>
      <div class="menu-item" data-action="modes">
        <span class="menu-item-icon">üéÆ</span> Game Modes
      </div>
      <div class="menu-item" data-action="settings">
        <span class="menu-item-icon">‚öôÔ∏è</span> Settings
      </div>
      <div class="menu-item" data-action="parent">
        <span class="menu-item-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Parent Zone
      </div>
      <div class="menu-item" data-action="about">
        <span class="menu-item-icon">‚ÑπÔ∏è</span> About
      </div>
    </div>
    
    <!-- Overlay for Menu -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Game Content Area -->
    <div class="game-content">
      <!-- Welcome Screen -->
      <div class="mode-container active" id="home-screen">
        <div class="welcome-screen">
          <h2 class="welcome-title">Welcome to Color Adventure!</h2>
          <p class="welcome-subtitle">A fun way for toddlers to learn colors</p>
          <button class="start-btn" id="start-btn">Start Playing</button>
        </div>
      </div>
      
      <!-- Game Modes Selection -->
      <div class="mode-container" id="modes-screen">
        <h2 class="game-title">Choose a Mode</h2>
        <div class="game-modes">
          <div class="mode-card" data-mode="classic">
            <div class="mode-icon">üé®</div>
            <div class="mode-title">Classic</div>
            <div class="mode-description">Learn colors in different categories</div>
          </div>
          <div class="mode-card" data-mode="quiz">
            <div class="mode-icon">‚ùì</div>
            <div class="mode-title">Quiz</div>
            <div class="mode-description">Test your color knowledge</div>
          </div>
          <div class="mode-card" data-mode="paint">
            <div class="mode-icon">üñåÔ∏è</div>
            <div class="mode-title">Paint</div>
            <div class="mode-description">Draw with different colors</div>
          </div>
          <div class="mode-card" data-mode="story">
            <div class="mode-icon">üìö</div>
            <div class="mode-title">Story</div>
            <div class="mode-description">Color adventures with stories</div>
          </div>
          <div class="mode-card" data-mode="match">
            <div class="mode-icon">üîÑ</div>
            <div class="mode-title">Match</div>
            <div class="mode-description">Match colors together</div>
          </div>
          <div class="mode-card" data-mode="dance">
            <div class="mode-icon">üíÉ</div>
            <div class="mode-title">Dance</div>
            <div class="mode-description">Dance with colorful friends</div>
          </div>
          <div class="mode-card" data-mode="peekaboo">
            <div class="mode-icon">üëÄ</div>
            <div class="mode-title">Peek-a-boo</div>
            <div class="mode-description">Find the hidden colors</div>
          </div>
          <div class="mode-card" data-mode="count">
            <div class="mode-icon">üî¢</div>
            <div class="mode-title">Count</div>
            <div class="mode-description">Count colorful objects</div>
          </div>
          <div class="mode-card" data-mode="bubbles">
            <div class="mode-icon">ü´ß</div>
            <div class="mode-title">Bubbles</div>
            <div class="mode-description">Pop colorful bubbles</div>
          </div>
          <div class="mode-card" data-mode="shapes">
            <div class="mode-icon">üî∂</div>
            <div class="mode-title">Shapes</div>
            <div class="mode-description">Learn colorful shapes</div>
          </div>
          <div class="mode-card" data-mode="music">
            <div class="mode-icon">üéµ</div>
            <div class="mode-title">Music</div>
            <div class="mode-description">Play with color sounds</div>
          </div>
          <div class="mode-card" data-mode="seasons">
            <div class="mode-icon">üçÇ</div>
            <div class="mode-title">Seasons</div>
            <div class="mode-description">Colors in nature</div>
          </div>
        </div>
      </div>
      
      <!-- Classic Mode -->
      <div class="mode-container" id="classic-mode">
        <div id="categories" class="categories"></div>
        <div id="color-buttons" class="buttons"></div>
      </div>
      
      <!-- Quiz Mode -->
      <div class="mode-container" id="quiz-mode">
        <div class="quiz-container">
          <div class="quiz-score" id="quiz-score">Score: 0</div>
          <div class="quiz-progress">
            <div class="quiz-progress-bar" id="quiz-progress-bar"></div>
          </div>
          <div class="quiz-question" id="quiz-question">Which one is Red?</div>
          <div class="quiz-options" id="quiz-options"></div>
        </div>
      </div>
      
      <!-- Paint Mode -->
      <div class="mode-container" id="paint-mode">
        <div class="paint-container">
          <div class="paint-toolbar">
            <div class="color-palette" id="paint-palette"></div>
            <div class="paint-actions">
              <button class="paint-btn" id="clear-canvas">Clear</button>
              <button class="paint-btn" id="save-canvas">Save</button>
            </div>
          </div>
          <div class="canvas-container">
            <canvas id="paint-canvas"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Story Mode -->
      <div class="mode-container" id="story-mode">
        <div class="story-container">
          <div class="story-image" id="story-image">
            <div class="big-emoji" id="story-emoji">üåà</div>
          </div>
          <div class="story-text" id="story-text">
            Once upon a time, there was a magical rainbow...
          </div>
          <div class="story-actions">
            <button class="story-btn" id="prev-story">‚Üê</button>
            <button class="story-btn" id="read-story">Read to Me</button>
            <button class="story-btn" id="next-story">‚Üí</button>
          </div>
        </div>
      </div>
      
      <!-- Match Mode -->
      <div class="mode-container" id="match-mode">
        <div class="match-container">
          <div class="match-header">
            <div class="match-score" id="match-score">Matches: 0</div>
            <div class="match-timer" id="match-timer">Time: 0</div>
          </div>
          <div class="match-board" id="match-board"></div>
          <div class="match-controls">
            <button class="match-btn" id="new-match-game">New Game</button>
            <select class="match-level" id="match-level">
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Dance Mode -->
      <div class="mode-container" id="dance-mode">
        <div class="dance-container">
          <div class="dance-stage" id="dance-stage">
            <div class="dancer" id="main-dancer">üß∏</div>
          </div>
          <div class="dance-color-picker">
            <div class="dance-instruction">Tap a color to make the dancer move!</div>
            <div class="dance-colors" id="dance-colors"></div>
          </div>
          <div class="dance-controls">
            <button class="dance-btn" id="dance-music-toggle">Music: ON</button>
            <button class="dance-btn" id="change-dancer">Change Dancer</button>
          </div>
        </div>
      </div>
      
      <!-- Peek-a-boo Mode -->
      <div class="mode-container" id="peekaboo-mode">
        <div class="peekaboo-container">
          <div class="peekaboo-score" id="peekaboo-score">Found: 0</div>
          <div class="peekaboo-stage" id="peekaboo-stage">
            <div class="peekaboo-instruction">Where did the colors hide?</div>
          </div>
          <div class="peekaboo-controls">
            <button class="peekaboo-btn" id="peekaboo-start">Start New Game</button>
            <div class="peekaboo-difficulty">
              <span>Speed:</span>
              <button class="peekaboo-speed-btn active" data-speed="slow">Slow</button>
              <button class="peekaboo-speed-btn" data-speed="medium">Medium</button>
              <button class="peekaboo-speed-btn" data-speed="fast">Fast</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Count Mode -->
      <div class="mode-container" id="count-mode">
        <div class="count-container">
          <div class="count-header">
            <div class="count-score" id="count-score">Score: 0</div>
          </div>
          <div class="count-stage" id="count-stage">
            <div class="count-question" id="count-question">How many objects do you see?</div>
            <div class="count-objects" id="count-objects"></div>
          </div>
          <div class="count-answer">
            <button class="count-number-btn" data-number="1">1</button>
            <button class="count-number-btn" data-number="2">2</button>
            <button class="count-number-btn" data-number="3">3</button>
          </div>
          <div class="count-controls">
            <button class="count-btn" id="count-next">Next</button>
          </div>
        </div>
      </div>
      
      <!-- Bubbles Mode -->
      <div class="mode-container" id="bubbles-mode">
        <div class="bubbles-container">
          <div class="bubbles-score" id="bubbles-score">Popped: 0</div>
          <div class="bubbles-stage" id="bubbles-stage"></div>
          <div class="bubbles-controls">
            <button class="bubbles-btn" id="bubbles-start">Start Game</button>
            <div class="bubbles-options">
              <span>Bubbles:</span>
              <button class="bubbles-amount-btn active" data-amount="few">Few</button>
              <button class="bubbles-amount-btn" data-amount="many">Many</button>
              <button class="bubbles-amount-btn" data-amount="lots">Lots</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Shapes Mode -->
      <div class="mode-container" id="shapes-mode">
        <div class="shapes-container">
          <div class="shapes-header">
            <div class="shapes-title">Touch the shapes to learn colors!</div>
          </div>
          <div class="shapes-board" id="shapes-board"></div>
          <div class="shapes-controls">
            <div class="shapes-selector">
              <button class="shape-type-btn active" data-shape="all">All Shapes</button>
              <button class="shape-type-btn" data-shape="basic">Basic</button>
              <button class="shape-type-btn" data-shape="complex">Complex</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Music Mode -->
      <div class="mode-container" id="music-mode">
        <div class="music-container">
          <div class="music-header">
            <div class="music-title">Tap colors to play music!</div>
          </div>
          <div class="music-stage" id="music-stage">
            <div class="music-instrument" id="music-instrument">üéπ</div>
          </div>
          <div class="music-keys" id="music-keys"></div>
          <div class="music-controls">
            <button class="music-btn" id="change-instrument">Change Instrument</button>
            <button class="music-btn" id="play-song">Play Song</button>
          </div>
        </div>
      </div>
      
      <!-- Seasons Mode -->
      <div class="mode-container" id="seasons-mode">
        <div class="seasons-container">
          <div class="seasons-header">
            <div class="seasons-title">Colors change with seasons!</div>
          </div>
          <div class="seasons-display" id="seasons-display">
            <div class="season-scene" id="season-scene"></div>
            <div class="season-name" id="season-name">Spring</div>
          </div>
          <div class="seasons-controls">
            <button class="season-btn" data-season="spring">Spring üå∏</button>
            <button class="season-btn" data-season="summer">Summer ‚òÄÔ∏è</button>
            <button class="season-btn" data-season="autumn">Autumn üçÇ</button>
            <button class="season-btn" data-season="winter">Winter ‚ùÑÔ∏è</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Navigation -->
    <div class="nav-buttons">
      <button class="nav-btn" id="back-btn">
        <span class="nav-btn-icon">‚Üê</span> Back
      </button>
      <button class="nav-btn" id="home-btn">
        <span class="nav-btn-icon">üè†</span> Home
      </button>
    </div>
  </div>

  <!-- Game Assets and Effects -->
  <div id="star" class="star hidden">‚≠ê</div>
  <div id="confetti" class="confetti"></div>
  <div id="color-popup" class="color-popup"></div>
  <div id="audio-container"></div>
  
  <script>
    // Game State and Navigation System
    const gameState = {
      currentScreen: 'home-screen',
      previousScreen: null,
      currentCategory: 'Animals',
      settings: {
        sound: true,
        speech: true,
        animations: true,
        haptic: true
      },
      userProgress: {
        visitedColors: {},
        achievements: [],
        colorKnowledge: {}
      }
    };

    // Core UI Elements
    const elements = {
      menuToggle: document.getElementById('menu-toggle'),
      menuClose: document.getElementById('menu-close'),
      menuItems: document.querySelectorAll('.menu-item'),
      gameMenu: document.getElementById('game-menu'),
      overlay: document.getElementById('overlay'),
      modeCards: document.querySelectorAll('.mode-card'),
      startBtn: document.getElementById('start-btn'),
      backBtn: document.getElementById('back-btn'),
      homeBtn: document.getElementById('home-btn'),
      screens: document.querySelectorAll('.mode-container'),
      categoriesDiv: document.getElementById('categories'),
      colorButtonsDiv: document.getElementById('color-buttons'),
      star: document.getElementById('star'),
      confetti: document.getElementById('confetti'),
      colorPopup: document.getElementById('color-popup'),
      audioContainer: document.getElementById('audio-container')
    };

    // Expanded color data by category
    const colorCategories = {
      Animals: [
        { name: 'Brown', color: 'brown', emoji: 'ü¶ä' },
        { name: 'Black', color: 'black', emoji: 'üêß' },
        { name: 'White', color: 'white', emoji: 'üêë' },
        { name: 'Gray', color: 'gray', emoji: 'üêò' },
        { name: 'Orange', color: 'orange', emoji: 'ü¶Å' },
        { name: 'Yellow', color: 'yellow', emoji: 'üê•' },
        { name: 'Red', color: 'red', emoji: 'ü¶ú' },
        { name: 'Blue', color: 'blue', emoji: 'üêü' },
        { name: 'Green', color: 'green', emoji: 'üê∏' },
        { name: 'Pink', color: 'pink', emoji: 'üê∑' },
        { name: 'Purple', color: 'purple', emoji: 'üêô' },
      ],
      Food: [
        { name: 'Red', color: 'red', emoji: 'üçé' },
        { name: 'Green', color: 'green', emoji: 'ü•¶' },
        { name: 'Yellow', color: 'yellow', emoji: 'üçå' },
        { name: 'Orange', color: 'orange', emoji: 'üçä' },
        { name: 'Purple', color: 'purple', emoji: 'üçá' },
        { name: 'Brown', color: 'brown', emoji: 'üç´' },
        { name: 'Pink', color: 'pink', emoji: 'üçß' },
        { name: 'Blue', color: 'blue', emoji: 'ü´ê' },
        { name: 'White', color: 'white', emoji: 'ü•õ' },
        { name: 'Black', color: 'black', emoji: 'üçá' },
        { name: 'Gold', color: 'gold', emoji: 'üçØ' },
      ],
      Plants: [
        { name: 'Green', color: 'green', emoji: 'üåø' },
        { name: 'Brown', color: 'brown', emoji: 'üå∞' },
        { name: 'Yellow', color: 'yellow', emoji: 'üåª' },
        { name: 'Red', color: 'red', emoji: 'üåπ' },
        { name: 'Pink', color: 'pink', emoji: 'üå∏' },
        { name: 'Orange', color: 'orange', emoji: 'üå∫' },
        { name: 'Purple', color: 'purple', emoji: 'ü™ª' },
        { name: 'Blue', color: 'blue', emoji: 'üíê' },
        { name: 'White', color: 'white', emoji: 'üåº' },
        { name: 'Black', color: 'black', emoji: 'ü™¥' },
      ],
      Nature: [
        { name: 'Blue', color: 'blue', emoji: 'üåä' },
        { name: 'Green', color: 'green', emoji: 'üå≥' },
        { name: 'Yellow', color: 'yellow', emoji: '‚òÄÔ∏è' },
        { name: 'Gray', color: 'gray', emoji: '‚õÖ' },
        { name: 'White', color: 'white', emoji: '‚ùÑÔ∏è' },
        { name: 'Orange', color: 'orange', emoji: 'üåÖ' },
        { name: 'Purple', color: 'purple', emoji: 'üåå' },
        { name: 'Pink', color: 'pink', emoji: 'üå∏' },
        { name: 'Red', color: 'red', emoji: 'üåã' },
        { name: 'Brown', color: 'brown', emoji: 'ü™®' },
      ],
      Toys: [
        { name: 'Red', color: 'red', emoji: 'üéØ' },
        { name: 'Blue', color: 'blue', emoji: 'üß∏' },
        { name: 'Green', color: 'green', emoji: 'ü™Ä' },
        { name: 'Yellow', color: 'yellow', emoji: 'üß©' },
        { name: 'Purple', color: 'purple', emoji: 'üé™' },
        { name: 'Pink', color: 'pink', emoji: 'üéÄ' },
        { name: 'Orange', color: 'orange', emoji: 'üé°' },
        { name: 'Brown', color: 'brown', emoji: 'üß∂' },
        { name: 'White', color: 'white', emoji: 'üé≠' },
        { name: 'Black', color: 'black', emoji: 'üéÆ' },
      ],
      Vehicles: [
        { name: 'Red', color: 'red', emoji: 'üöí' },
        { name: 'Blue', color: 'blue', emoji: 'üöì' },
        { name: 'Yellow', color: 'yellow', emoji: 'üöï' },
        { name: 'Green', color: 'green', emoji: 'üöú' },
        { name: 'White', color: 'white', emoji: '‚úàÔ∏è' },
        { name: 'Orange', color: 'orange', emoji: 'üöö' },
        { name: 'Black', color: 'black', emoji: 'üèéÔ∏è' },
        { name: 'Silver', color: 'silver', emoji: 'üöÄ' },
        { name: 'Purple', color: 'purple', emoji: 'üöÇ' },
        { name: 'Brown', color: 'brown', emoji: 'üõ∂' },
      ]
    };

    // Color to gradient backgrounds
    const colorGradients = {
      red: 'linear-gradient(135deg, #ff4b5c 60%, #ffb3b3 100%)',
      green: 'linear-gradient(135deg, #4be37a 60%, #b3ffd1 100%)',
      blue: 'linear-gradient(135deg, #4bafff 60%, #b3e0ff 100%)',
      yellow: 'linear-gradient(135deg, #ffe34b 60%, #fff7b3 100%)',
      orange: 'linear-gradient(135deg, #ffb347 60%, #ffe0b3 100%)',
      purple: 'linear-gradient(135deg, #a259f7 60%, #e0b3ff 100%)',
      pink: 'linear-gradient(135deg, #ff7eb9 60%, #ffd1e3 100%)',
      brown: 'linear-gradient(135deg, #a0522d 60%, #deb887 100%)',
      black: 'linear-gradient(135deg, #222 60%, #555 100%)',
      white: 'linear-gradient(135deg, #fff 60%, #f7e9ff 100%)',
      gray: 'linear-gradient(135deg, #bdbdbd 60%, #f0f0f0 100%)',
      gold: 'linear-gradient(135deg, #ffd700 60%, #fff7b3 100%)',
      silver: 'linear-gradient(135deg, #c0c0c0 60%, #f8f8ff 100%)',
    };

    // Category to specific audio mapping
    const categoryAudioSrc = {
      Animals: 'https://cdn.pixabay.com/audio/2021/08/04/audio_dc39bbc103.mp3', // Animal sound
      Food: 'https://cdn.pixabay.com/audio/2022/03/10/audio_2cad3aaded.mp3', // Food sound
      Plants: 'https://cdn.pixabay.com/audio/2021/08/09/audio_c9a4a1d539.mp3', // Plant sound
      Nature: 'https://cdn.pixabay.com/audio/2022/01/18/audio_e6a1be27e2.mp3', // Nature sound
      Toys: 'https://cdn.pixabay.com/audio/2022/11/17/audio_8130e9d75f.mp3', // Toy sound
      Vehicles: 'https://cdn.pixabay.com/audio/2022/01/27/audio_bb630cc098.mp3' // Vehicle sound
    };

    // Dynamically create audio elements for all unique colors
    function createAudioElements() {
      const audioContainer = document.getElementById('audio-container');
      audioContainer.innerHTML = '';
      
      // Create UI sounds
      const uiSounds = {
        click: 'https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b6b7c.mp3',
        success: 'https://cdn.pixabay.com/audio/2022/03/25/audio_c8a4bf9c76.mp3',
        error: 'https://cdn.pixabay.com/audio/2022/11/17/audio_d4e9d8970c.mp3',
        transition: 'https://cdn.pixabay.com/audio/2022/04/27/audio_f1cb5ec4af.mp3'
      };
      
      Object.entries(uiSounds).forEach(([name, src]) => {
        const audio = document.createElement('audio');
        audio.id = 'sound-ui-' + name;
        audio.src = src;
        audio.preload = 'auto';
        audioContainer.appendChild(audio);
      });
      
      // Create category sounds
      Object.entries(categoryAudioSrc).forEach(([category, src]) => {
        const audio = document.createElement('audio');
        audio.id = 'sound-category-' + category.toLowerCase();
        audio.src = src;
        audio.preload = 'auto';
        audioContainer.appendChild(audio);
      });
      
      // Create color sounds (using category sounds for relevant colors)
      const uniqueColors = new Set();
      Object.values(colorCategories).flat().forEach(({ color }) => uniqueColors.add(color));
      
      uniqueColors.forEach(color => {
        const audio = document.createElement('audio');
        audio.id = 'sound-' + color;
        audio.src = 'https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b6b7c.mp3'; // Default sound
        audio.preload = 'auto';
        audioContainer.appendChild(audio);
      });
    }

    // Initialize Core Navigation
    function initializeNavigation() {
      // Menu Toggle
      elements.menuToggle.addEventListener('click', () => {
        playUISound('click');
        elements.gameMenu.classList.add('active');
        elements.overlay.classList.add('active');
      });
      
      elements.menuClose.addEventListener('click', () => {
        playUISound('click');
        elements.gameMenu.classList.remove('active');
        elements.overlay.classList.remove('active');
      });
      
      elements.overlay.addEventListener('click', () => {
        elements.gameMenu.classList.remove('active');
        elements.overlay.classList.remove('active');
      });
      
      // Menu Items
      elements.menuItems.forEach(item => {
        item.addEventListener('click', () => {
          const action = item.getAttribute('data-action');
          playUISound('click');
          handleMenuAction(action);
          elements.gameMenu.classList.remove('active');
          elements.overlay.classList.remove('active');
        });
      });
      
      // Mode Cards
      elements.modeCards.forEach(card => {
        card.addEventListener('click', () => {
          const mode = card.getAttribute('data-mode');
          playUISound('transition');
          navigateToScreen(`${mode}-mode`);
        });
      });
      
      // Start Button
      elements.startBtn.addEventListener('click', () => {
        playUISound('transition');
        navigateToScreen('modes-screen');
      });
      
      // Back Button
      elements.backBtn.addEventListener('click', () => {
        playUISound('click');
        if (gameState.previousScreen) {
          navigateToScreen(gameState.previousScreen);
        }
      });
      
      // Home Button
      elements.homeBtn.addEventListener('click', () => {
        playUISound('transition');
        navigateToScreen('home-screen');
      });
    }

    // Play UI Sound Effect
    function playUISound(soundName) {
      if (!gameState.settings.sound) return;
      
      const sound = document.getElementById('sound-ui-' + soundName);
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(err => console.log('UI sound play failed:', err));
      }
    }

    // Navigation Helper
    function navigateToScreen(screenId) {
      showLoading(true);
      
      setTimeout(() => {
        gameState.previousScreen = gameState.currentScreen;
        gameState.currentScreen = screenId;
        
        elements.screens.forEach(screen => {
          screen.classList.remove('active');
        });
        
        document.getElementById(screenId).classList.add('active');
        
        // Initialize specific modes
        if (screenId === 'classic-mode') {
          initializeClassicMode();
        } else if (screenId === 'quiz-mode') {
          initializeQuizMode();
        } else if (screenId === 'paint-mode') {
          initializePaintMode();
        } else if (screenId === 'story-mode') {
          initializeStoryMode();
        } else if (screenId === 'match-mode') {
          initializeMatchMode();
        } else if (screenId === 'dance-mode') {
          initializeDanceMode();
        } else if (screenId === 'peekaboo-mode') {
          initializePeekabooMode();
        } else if (screenId === 'count-mode') {
          initializeCountMode();
        } else if (screenId === 'bubbles-mode') {
          initializeBubblesMode();
        } else if (screenId === 'shapes-mode') {
          initializeShapesMode();
        } else if (screenId === 'music-mode') {
          initializeMusicMode();
        } else if (screenId === 'seasons-mode') {
          initializeSeasonsMode();
        }
        
        showLoading(false);
      }, 300);
    }

    // Menu Action Handler
    function handleMenuAction(action) {
      switch(action) {
        case 'home':
          navigateToScreen('home-screen');
          break;
        case 'modes':
          navigateToScreen('modes-screen');
          break;
        case 'settings':
          createSettingsPanel();
          break;
        case 'parent':
          createParentZone();
          break;
        case 'about':
          showAboutInfo();
          break;
      }
    }

    // Initialize Classic Mode
    function initializeClassicMode() {
      renderCategories();
      renderColorButtons();
    }

    // Render Categories
    function renderCategories() {
      if (!elements.categoriesDiv) return;
      
      elements.categoriesDiv.innerHTML = '';
      Object.keys(colorCategories).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn' + (cat === gameState.currentCategory ? ' active' : '');
        btn.textContent = cat;
        btn.onclick = () => {
          playUISound('click');
          gameState.currentCategory = cat;
          renderCategories();
          renderColorButtons();
          
          // Play category switch sound
          const categoryAudio = document.getElementById('sound-category-' + cat.toLowerCase());
          if (categoryAudio && gameState.settings.sound) {
            categoryAudio.currentTime = 0;
            categoryAudio.play().catch(err => console.log('Category audio failed:', err));
          }
        };
        elements.categoriesDiv.appendChild(btn);
      });
    }

    // Render Color Buttons
    function renderColorButtons() {
      if (!elements.colorButtonsDiv) return;
      
      elements.colorButtonsDiv.innerHTML = '';
      colorCategories[gameState.currentCategory].forEach(({ name, color, emoji }) => {
        const btn = document.createElement('button');
        btn.className = 'color-btn';
        btn.style.background = colorGradients[color] || color;
        btn.innerHTML = emoji + '<br>' + name;
        btn.onclick = () => play(color, name, emoji);
        elements.colorButtonsDiv.appendChild(btn);
        
        // Track visited colors
        if (gameState.userProgress.visitedColors[color]) {
          gameState.userProgress.visitedColors[color]++;
        } else {
          gameState.userProgress.visitedColors[color] = 1;
        }
      });
    }

    // Play function for all colors
    function play(color, name, emoji) {
      // Play sound
      if (gameState.settings.sound) {
        const audio = document.getElementById('sound-' + color);
        if (audio) {
          audio.currentTime = 0;
          audio.play().catch(err => {
            console.log('Audio play failed:', err);
            // Try to play the category sound as fallback
            const categoryAudio = document.getElementById('sound-category-' + gameState.currentCategory.toLowerCase());
            if (categoryAudio) categoryAudio.play().catch(() => {});
          });
        }
      }
      
      // Show star animation
      if (gameState.settings.animations) {
        const star = elements.star;
        star.classList.remove('hidden');
        star.classList.add('show');
        setTimeout(() => star.classList.remove('show'), 900);
      }
      
      // Confetti burst
      if (gameState.settings.animations) {
        confettiBurst(color);
      }
      
      // Show color popup and speak
      showColorPopup(color, name, emoji);
      
      // Update user progress
      updateUserProgress(color, name);
    }

    // Update User Progress
    function updateUserProgress(color, name) {
      // Increment color knowledge
      if (!gameState.userProgress.colorKnowledge[color]) {
        gameState.userProgress.colorKnowledge[color] = {
          views: 0,
          lastViewed: Date.now()
        };
      }
      
      gameState.userProgress.colorKnowledge[color].views++;
      gameState.userProgress.colorKnowledge[color].lastViewed = Date.now();
      
      // Check for achievements
      checkAchievements();
      
      // Save progress
      saveProgress();
    }

    // Save User Progress
    function saveProgress() {
      try {
        localStorage.setItem('colorGameProgress', JSON.stringify(gameState.userProgress));
      } catch (e) {
        console.log('Could not save progress:', e);
      }
    }

    // Load User Progress
    function loadProgress() {
      try {
        const savedProgress = localStorage.getItem('colorGameProgress');
        if (savedProgress) {
          gameState.userProgress = JSON.parse(savedProgress);
        }
      } catch (e) {
        console.log('Could not load progress:', e);
      }
    }

    // Check for Achievements
    function checkAchievements() {
      const totalColors = Object.keys(gameState.userProgress.colorKnowledge).length;
      const totalViews = Object.values(gameState.userProgress.colorKnowledge)
        .reduce((sum, item) => sum + item.views, 0);
      
      // Check for new achievements
      const achievements = [
        { id: 'first_color', condition: totalViews >= 1, title: 'First Color!' },
        { id: 'five_colors', condition: totalColors >= 5, title: 'Five Colors!' },
        { id: 'all_categories', condition: Object.keys(colorCategories).every(cat => 
          colorCategories[cat].some(item => gameState.userProgress.colorKnowledge[item.color])), 
          title: 'Category Explorer' },
        { id: 'color_master', condition: totalViews >= 50, title: 'Color Master' }
      ];
      
      achievements.forEach(achievement => {
        if (achievement.condition && 
            !gameState.userProgress.achievements.includes(achievement.id)) {
          gameState.userProgress.achievements.push(achievement.id);
          showAchievement(achievement.title);
        }
      });
    }

    // Show Achievement
    function showAchievement(title) {
      // Create achievement popup
      const achievementPopup = document.createElement('div');
      achievementPopup.className = 'achievement-popup';
      achievementPopup.innerHTML = `
        <div class="achievement-icon">üèÜ</div>
        <div class="achievement-text">
          <div class="achievement-title rainbow-text">Achievement Unlocked!</div>
          <div class="achievement-name">${title}</div>
        </div>
      `;
      
      document.body.appendChild(achievementPopup);
      
      // Show animation
      setTimeout(() => {
        achievementPopup.classList.add('show');
        playUISound('success');
        
        // Add special effects
        confettiBurst('gold');
        const trophy = achievementPopup.querySelector('.achievement-icon');
        trophy.classList.add('glow-effect');
      }, 100);
      
      // Remove after animation
      setTimeout(() => {
        achievementPopup.classList.remove('show');
        setTimeout(() => achievementPopup.remove(), 500);
      }, 4000);
    }

    // Confetti Burst Effect
    function confettiBurst(color) {
      const confetti = elements.confetti;
      if (!confetti) return;
      
      // Expanded color mapping for all colors
      const colors = {
        red: ['#ff4b5c', '#ffb3b3', '#fff'],
        green: ['#4be37a', '#b3ffd1', '#fff'],
        blue: ['#4bafff', '#b3e0ff', '#fff'],
        yellow: ['#ffe34b', '#fff7b3', '#fff'],
        orange: ['#ffb347', '#ffe0b3', '#fff'],
        purple: ['#a259f7', '#e0b3ff', '#fff'],
        pink: ['#ff7eb9', '#ffd1e3', '#fff'],
        brown: ['#a0522d', '#deb887', '#fff'],
        black: ['#222', '#555', '#fff'],
        white: ['#fff', '#f7e9ff', '#ddd'],
        gray: ['#bdbdbd', '#f0f0f0', '#fff'],
        gold: ['#ffd700', '#fff7b3', '#fff'],
        silver: ['#c0c0c0', '#f8f8ff', '#fff']
      };
      
      // Use color-specific confetti or default to white/grey
      const confettiColors = colors[color] || ['#fff', '#ddd', '#ccc'];
      
      // Create different shapes for more fun
      const shapes = ['confetti-piece', 'confetti-square', 'confetti-circle', 'confetti-triangle'];
      
      for (let i = 0; i < 30; i++) {
        const piece = document.createElement('div');
        const shape = shapes[Math.floor(Math.random() * shapes.length)];
        piece.className = shape;
        
        // Random position, more concentrated toward center
        const centerBias = Math.random() * 0.6 + 0.2; // 0.2 to 0.8
        piece.style.left = (50 + (Math.random() - 0.5) * 60 * centerBias) + 'vw';
        piece.style.top = (40 + (Math.random() - 0.5) * 30 * centerBias) + 'vh';
        
        // Random color from our palette
        const pieceColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
        if (shape === 'confetti-triangle') {
          piece.style.borderBottomColor = pieceColor;
        } else {
          piece.style.background = pieceColor;
        }
        
        // Random rotation and size
        piece.style.transform = `rotate(${Math.random() * 360}deg) scale(${Math.random() * 0.5 + 0.7})`;
        piece.style.animationDelay = (Math.random() * 0.4) + 's';
        piece.style.animationDuration = (Math.random() * 0.5 + 1.2) + 's';
        
        confetti.appendChild(piece);
        setTimeout(() => {
          if (confetti.contains(piece)) confetti.removeChild(piece);
        }, 2000);
      }
      
      // Add sparkles for extra pizzazz
      addSparkles(color);
    }

    // Add Sparkle Effect
    function addSparkles(color) {
      const sizes = ['sparkle-sm', 'sparkle-md', 'sparkle-lg'];
      
      for (let i = 0; i < 15; i++) {
        setTimeout(() => {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle ' + sizes[Math.floor(Math.random() * sizes.length)];
          
          // Random position around the center
          sparkle.style.left = (45 + Math.random() * 10) + 'vw';
          sparkle.style.top = (35 + Math.random() * 10) + 'vh';
          
          document.body.appendChild(sparkle);
          
          // Remove after animation completes
          setTimeout(() => sparkle.remove(), 1000);
        }, Math.random() * 500); // Stagger the sparkles
      }
    }

    // Show Color Popup
    function showColorPopup(color, name, emoji) {
      const popup = elements.colorPopup;
      if (!popup) return;
      
      popup.innerHTML = `<span class="popup-emoji">${emoji}</span>${name}`;
      popup.style.color = color;
      popup.style.borderColor = color;
      popup.classList.add('show');
      
      // Add subtle movement
      popup.style.animation = 'popIn 0.4s ease-out, float 3s ease-in-out infinite';
      
      setTimeout(() => {
        popup.classList.remove('show');
        popup.style.animation = '';
      }, 1600);
      
      // Text-to-speech
      if (gameState.settings.speech) {
        speakColor(name);
      }
    }

    // Speak Color Name
    function speakColor(text) {
      if ('speechSynthesis' in window) {
        // Cancel any previous speech
        window.speechSynthesis.cancel();
        
        const utter = new window.SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        utter.rate = 0.8;
        utter.pitch = 1.2;
        window.speechSynthesis.speak(utter);
      }
    }

    // Settings Panel
    function createSettingsPanel() {
      // Create a settings modal
      const settingsModal = document.createElement('div');
      settingsModal.className = 'modal';
      settingsModal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2>Settings</h2>
            <button class="modal-close">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="settings-group">
              <div class="setting-item">
                <span class="setting-label">Sound Effects</span>
                <label class="setting-toggle">
                  <input type="checkbox" id="setting-sound" ${gameState.settings.sound ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <span class="setting-label">Speech</span>
                <label class="setting-toggle">
                  <input type="checkbox" id="setting-speech" ${gameState.settings.speech ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <span class="setting-label">Animations</span>
                <label class="setting-toggle">
                  <input type="checkbox" id="setting-animations" ${gameState.settings.animations ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="setting-item">
                <span class="setting-label">Haptic Feedback</span>
                <label class="setting-toggle">
                  <input type="checkbox" id="setting-haptic" ${gameState.settings.haptic ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
            <div class="settings-buttons">
              <button class="settings-reset">Reset All Progress</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(settingsModal);
      
      // Handle settings changes
      const soundToggle = document.getElementById('setting-sound');
      const speechToggle = document.getElementById('setting-speech');
      const animationsToggle = document.getElementById('setting-animations');
      const hapticToggle = document.getElementById('setting-haptic');
      const resetBtn = settingsModal.querySelector('.settings-reset');
      const closeBtn = settingsModal.querySelector('.modal-close');
      
      soundToggle.addEventListener('change', () => {
        gameState.settings.sound = soundToggle.checked;
        playUISound('click');
        saveSettings();
      });
      
      speechToggle.addEventListener('change', () => {
        gameState.settings.speech = speechToggle.checked;
        playUISound('click');
        saveSettings();
      });
      
      animationsToggle.addEventListener('change', () => {
        gameState.settings.animations = animationsToggle.checked;
        playUISound('click');
        saveSettings();
      });
      
      hapticToggle.addEventListener('change', () => {
        gameState.settings.haptic = hapticToggle.checked;
        playUISound('click');
        saveSettings();
      });
      
      resetBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to reset all progress?')) {
          resetAllProgress();
          playUISound('transition');
          settingsModal.remove();
        }
      });
      
      closeBtn.addEventListener('click', () => {
        playUISound('click');
        settingsModal.remove();
      });
      
      // Add styles for the modal
      const modalStyle = document.createElement('style');
      modalStyle.textContent = `
        .modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }
        
        .modal-content {
          background: white;
          border-radius: 20px;
          width: 90%;
          max-width: 500px;
          max-height: 90%;
          overflow-y: auto;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px;
          border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
          margin: 0;
          color: var(--primary-color);
        }
        
        .modal-close {
          background: none;
          border: none;
          font-size: 1.5em;
          cursor: pointer;
          color: #666;
        }
        
        .modal-body {
          padding: 20px;
        }
        
        .settings-group {
          margin-bottom: 20px;
        }
        
        .setting-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
        }
        
        .setting-label {
          font-size: 1.1em;
        }
        
        .setting-toggle {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }
        
        .setting-toggle input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        
        .toggle-slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 34px;
        }
        
        .toggle-slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
          background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
          transform: translateX(26px);
        }
        
        .settings-buttons {
          display: flex;
          justify-content: center;
        }
        
        .settings-reset {
          background: var(--secondary-color);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 10px;
          cursor: pointer;
          font-size: 1em;
        }
        
        .achievement-popup {
          position: fixed;
          bottom: -100px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 255, 255, 0.95);
          border-radius: 15px;
          padding: 15px;
          display: flex;
          align-items: center;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
          transition: bottom 0.5s ease;
          z-index: 1000;
        }
        
        .achievement-popup.show {
          bottom: 20px;
        }
        
        .achievement-icon {
          font-size: 2em;
          margin-right: 15px;
        }
        
        .achievement-title {
          font-weight: bold;
          color: var(--primary-color);
        }
        
        .achievement-name {
          color: var(--text-color);
          margin-top: 5px;
        }
      `;
      
      document.head.appendChild(modalStyle);
    }

    // Save Settings
    function saveSettings() {
      try {
        localStorage.setItem('colorGameSettings', JSON.stringify(gameState.settings));
      } catch (e) {
        console.log('Could not save settings:', e);
      }
    }

    // Load Settings
    function loadSettings() {
      try {
        const savedSettings = localStorage.getItem('colorGameSettings');
        if (savedSettings) {
          gameState.settings = JSON.parse(savedSettings);
        }
      } catch (e) {
        console.log('Could not load settings:', e);
      }
    }

    // Reset All Progress
    function resetAllProgress() {
      gameState.userProgress = {
        visitedColors: {},
        achievements: [],
        colorKnowledge: {}
      };
      saveProgress();
    }

    // Parent Zone
    function createParentZone() {
      alert('Parent Zone - Coming Soon!');
    }

    // About Information
    function showAboutInfo() {
      alert('Color Adventure Game - A fun way for toddlers to learn colors!');
    }

    // Quiz Mode Functionality
    const quizState = {
      currentQuestion: 0,
      score: 0,
      totalQuestions: 10,
      currentCategory: null,
      questions: [],
      answeredCorrectly: false
    };

    function initializeQuizMode() {
      // Reset quiz state
      quizState.currentQuestion = 0;
      quizState.score = 0;
      quizState.answeredCorrectly = false;
      
      // Select a random category
      const categories = Object.keys(colorCategories);
      quizState.currentCategory = categories[Math.floor(Math.random() * categories.length)];
      
      // Generate questions
      generateQuizQuestions();
      
      // Display first question
      displayQuizQuestion();
      
      // Update UI
      updateQuizProgress();
      document.getElementById('quiz-score').textContent = `Score: ${quizState.score}`;
    }

    function generateQuizQuestions() {
      quizState.questions = [];
      
      // Create a pool of all colors
      const allColors = [];
      Object.values(colorCategories).forEach(categoryColors => {
        categoryColors.forEach(color => {
          allColors.push(color);
        });
      });
      
      // Generate questions
      for (let i = 0; i < quizState.totalQuestions; i++) {
        // Select correct answer
        const correctColorObj = allColors[Math.floor(Math.random() * allColors.length)];
        
        // Get other options (make sure they're different colors)
        const options = [correctColorObj];
        while (options.length < 4) {
          const randomColor = allColors[Math.floor(Math.random() * allColors.length)];
          if (!options.some(opt => opt.color === randomColor.color)) {
            options.push(randomColor);
          }
        }
        
        // Shuffle options
        shuffleArray(options);
        
        // Create question
        const questionType = Math.random() > 0.5 ? 'color' : 'emoji';
        let questionText;
        
        if (questionType === 'color') {
          questionText = `Find the ${correctColorObj.name} one`;
        } else {
          questionText = `What color is ${correctColorObj.emoji}?`;
        }
        
        quizState.questions.push({
          questionText,
          options,
          correctAnswer: correctColorObj,
          questionType
        });
      }
    }

    function displayQuizQuestion() {
      if (quizState.currentQuestion >= quizState.questions.length) {
        showQuizResults();
        return;
      }
      
      const question = quizState.questions[quizState.currentQuestion];
      const questionElement = document.getElementById('quiz-question');
      const optionsElement = document.getElementById('quiz-options');
      
      // Set question text
      questionElement.textContent = question.questionText;
      
      // Clear previous options
      optionsElement.innerHTML = '';
      
      // Add options
      question.options.forEach(option => {
        const optionElement = document.createElement('div');
        optionElement.className = 'quiz-option';
        
        // Display different content based on question type
        if (question.questionType === 'color') {
          optionElement.textContent = option.emoji;
          optionElement.style.background = colorGradients[option.color] || option.color;
        } else {
          optionElement.textContent = option.name;
          optionElement.style.background = '#f5f5f5';
          optionElement.style.color = option.color;
        }
        
        optionElement.addEventListener('click', () => {
          if (quizState.answeredCorrectly) return; // Prevent multiple answers
          
          const isCorrect = option.color === question.correctAnswer.color;
          
          if (isCorrect) {
            quizState.score++;
            quizState.answeredCorrectly = true;
            optionElement.classList.add('correct');
            playUISound('success');
            optionElement.style.animation = 'success-pulse 1s';
          } else {
            optionElement.classList.add('incorrect');
            playUISound('error');
            optionElement.style.animation = 'error-shake 0.5s';
            
            // Show the correct answer
            const correctOption = Array.from(optionsElement.children).find(
              el => el.textContent === (question.questionType === 'color' ? 
                question.correctAnswer.emoji : question.correctAnswer.name)
            );
            if (correctOption) correctOption.classList.add('correct');
          }
          
          document.getElementById('quiz-score').textContent = `Score: ${quizState.score}`;
          
          // Move to next question after delay
          setTimeout(() => {
            quizState.currentQuestion++;
            quizState.answeredCorrectly = false;
            updateQuizProgress();
            displayQuizQuestion();
          }, 1500);
        });
        
        optionsElement.appendChild(optionElement);
      });
    }

    function updateQuizProgress() {
      const progressBar = document.getElementById('quiz-progress-bar');
      const progress = (quizState.currentQuestion / quizState.totalQuestions) * 100;
      progressBar.style.width = `${progress}%`;
    }

    function showQuizResults() {
      const optionsElement = document.getElementById('quiz-options');
      const questionElement = document.getElementById('quiz-question');
      
      optionsElement.innerHTML = '';
      questionElement.innerHTML = `Quiz Complete!<br>Your Score: ${quizState.score} / ${quizState.totalQuestions}`;
      
      // Add a restart button
      const restartButton = document.createElement('button');
      restartButton.className = 'nav-btn';
      restartButton.textContent = 'Play Again';
      restartButton.addEventListener('click', () => {
        playUISound('click');
        initializeQuizMode();
      });
      
      optionsElement.appendChild(restartButton);
      
      // Add achievement if score is perfect
      if (quizState.score === quizState.totalQuestions) {
        // Check if achievement already exists
        if (!gameState.userProgress.achievements.includes('perfect_quiz')) {
          gameState.userProgress.achievements.push('perfect_quiz');
          saveProgress();
          showAchievement('Perfect Quiz!');
        }
      }
    }

    // Paint Mode Functionality
    let paintCanvas, paintCtx;
    let isPainting = false;
    let currentColor = '#ff4b5c'; // Default red

    function initializePaintMode() {
      paintCanvas = document.getElementById('paint-canvas');
      const canvasContainer = document.querySelector('.canvas-container');
      
      // Set canvas size
      paintCanvas.width = canvasContainer.offsetWidth;
      paintCanvas.height = canvasContainer.offsetHeight;
      
      paintCtx = paintCanvas.getContext('2d');
      paintCtx.lineCap = 'round';
      paintCtx.lineWidth = 15;
      
      // Clear canvas
      paintCtx.fillStyle = 'white';
      paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
      
      // Setup color palette
      const palette = document.getElementById('paint-palette');
      palette.innerHTML = '';
      
      // Add colors to palette
      const paletteColors = {
        red: '#ff4b5c',
        blue: '#4bafff',
        green: '#4be37a',
        yellow: '#ffe34b',
        orange: '#ffb347',
        purple: '#a259f7',
        pink: '#ff7eb9',
        brown: '#a0522d',
        black: '#222222',
        white: '#ffffff'
      };
      
      Object.entries(paletteColors).forEach(([name, color]) => {
        const colorElement = document.createElement('div');
        colorElement.className = 'palette-color';
        colorElement.style.background = color;
        if (color === currentColor) {
          colorElement.classList.add('selected');
        }
        
        colorElement.addEventListener('click', () => {
          // Remove selected class from all colors
          document.querySelectorAll('.palette-color').forEach(el => {
            el.classList.remove('selected');
          });
          
          // Select this color
          colorElement.classList.add('selected');
          currentColor = color;
          paintCtx.strokeStyle = color;
          
          playUISound('click');
        });
        
        palette.appendChild(colorElement);
      });
      
      // Set current color
      paintCtx.strokeStyle = currentColor;
      
      // Add event listeners for drawing
      paintCanvas.addEventListener('mousedown', startPaint);
      paintCanvas.addEventListener('mousemove', paint);
      paintCanvas.addEventListener('mouseup', endPaint);
      paintCanvas.addEventListener('mouseleave', endPaint);
      
      // Touch events
      paintCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
      paintCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
      paintCanvas.addEventListener('touchend', handleTouchEnd, { passive: false });
      
      // Clear button
      document.getElementById('clear-canvas').addEventListener('click', () => {
        playUISound('click');
        clearCanvas();
      });
      
      // Save button
      document.getElementById('save-canvas').addEventListener('click', () => {
        playUISound('success');
        saveCanvas();
      });
    }

    function startPaint(e) {
      isPainting = true;
      paint(e);
    }

    function paint(e) {
      if (!isPainting) return;
      
      const rect = paintCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      paintCtx.lineTo(x, y);
      paintCtx.stroke();
      paintCtx.beginPath();
      paintCtx.moveTo(x, y);
    }

    function endPaint() {
      isPainting = false;
      paintCtx.beginPath();
    }

    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      paintCanvas.dispatchEvent(mouseEvent);
    }

    function handleTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      paintCanvas.dispatchEvent(mouseEvent);
    }

    function handleTouchEnd(e) {
      e.preventDefault();
      const mouseEvent = new MouseEvent('mouseup', {});
      paintCanvas.dispatchEvent(mouseEvent);
    }

    function clearCanvas() {
      paintCtx.fillStyle = 'white';
      paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
    }

    function saveCanvas() {
      try {
        const image = paintCanvas.toDataURL('image/png');
        
        // Create a save indicator
        const saveIndicator = document.createElement('div');
        saveIndicator.textContent = 'Painting Saved! üé®';
        saveIndicator.style.position = 'fixed';
        saveIndicator.style.top = '50%';
        saveIndicator.style.left = '50%';
        saveIndicator.style.transform = 'translate(-50%, -50%)';
        saveIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
        saveIndicator.style.color = 'white';
        saveIndicator.style.padding = '15px 30px';
        saveIndicator.style.borderRadius = '10px';
        saveIndicator.style.zIndex = '1000';
        saveIndicator.style.fontSize = '1.5em';
        
        document.body.appendChild(saveIndicator);
        
        setTimeout(() => {
          saveIndicator.remove();
        }, 2000);
        
        // Store the image in localStorage
        try {
          // Store the 5 most recent paintings
          let savedPaintings = JSON.parse(localStorage.getItem('colorGamePaintings') || '[]');
          savedPaintings.unshift({
            date: new Date().toISOString(),
            image
          });
          
          // Keep only the 5 most recent
          savedPaintings = savedPaintings.slice(0, 5);
          
          localStorage.setItem('colorGamePaintings', JSON.stringify(savedPaintings));
        } catch (e) {
          console.log('Could not save painting:', e);
        }
        
      } catch (e) {
        console.log('Error saving canvas:', e);
      }
    }

    // Story Mode Functionality
    const storyState = {
      currentStory: 0,
      currentPage: 0,
      isPlaying: false,
      autoPlayDelay: 5000,
      autoPlayTimer: null,
      stories: [
        {
          title: "The Rainbow Adventure",
          pages: [
            {
              emoji: "üåà",
              text: "Once upon a time, there was a magical rainbow with all the colors of the world."
            },
            {
              emoji: "‚òÅÔ∏è",
              text: "But one day, a gray cloud came and took all the colors away!"
            },
            {
              emoji: "üò¢",
              text: "The rainbow was now empty and sad. It needed help to find its colors."
            },
            {
              emoji: "üê∞",
              text: "A little bunny named Hoppy decided to help find the missing colors."
            },
            {
              emoji: "üî¥",
              text: "First, Hoppy found the color red hiding in an apple tree."
            },
            {
              emoji: "üü†",
              text: "Then, Hoppy found orange hiding in a pumpkin patch."
            },
            {
              emoji: "üü°",
              text: "Yellow was playing in a field of sunflowers."
            },
            {
              emoji: "üü¢",
              text: "Green was relaxing in the tall grass."
            },
            {
              emoji: "üîµ",
              text: "Blue was swimming in the deep ocean."
            },
            {
              emoji: "üü£",
              text: "And purple was dancing with the butterflies."
            },
            {
              emoji: "üåà",
              text: "Hoppy returned all the colors to the rainbow, and it became bright and beautiful again!"
            },
            {
              emoji: "üéâ",
              text: "Everyone celebrated, and they all lived happily ever after in their colorful world."
            }
          ]
        },
        {
          title: "Colors in the Forest",
          pages: [
            {
              emoji: "üå≥",
              text: "In a magical forest, all the animals had their own special colors."
            },
            {
              emoji: "üêª",
              text: "The bear was proud of his brown fur, soft and warm."
            },
            {
              emoji: "ü¶ä",
              text: "The fox had beautiful orange fur that shimmered in the sunlight."
            },
            {
              emoji: "üê∏",
              text: "The frog was green like the leaves on the trees."
            },
            {
              emoji: "ü¶î",
              text: "The hedgehog was gray and loved to hide in the rocks."
            },
            {
              emoji: "üê¶",
              text: "The bluebird's feathers were as blue as the sky."
            },
            {
              emoji: "üåßÔ∏è",
              text: "One day, a magical rain washed away all their colors!"
            },
            {
              emoji: "üò±",
              text: "The animals didn't recognize each other without their colors."
            },
            {
              emoji: "ü¶â",
              text: "The wise owl told them that only kindness could bring their colors back."
            },
            {
              emoji: "‚ù§Ô∏è",
              text: "The animals helped each other and showed kindness to everyone they met."
            },
            {
              emoji: "‚ú®",
              text: "Slowly, their colors began to return, more vibrant than ever before!"
            },
            {
              emoji: "üåà",
              text: "The forest was filled with colors again, and the animals learned that kindness makes everything more beautiful."
            }
          ]
        }
      ]
    };

    function initializeStoryMode() {
      // Start autoplay when entering story mode
      startStoryAutoplay();
      
      // Update button text
      document.getElementById('read-story').textContent = storyState.isPlaying ? "Pause Story" : "Play Story";
      
      // Add event listeners
      document.getElementById('prev-story').addEventListener('click', () => {
        playUISound('click');
        pauseStoryAutoplay();
        prevStoryPage();
      });
      
      document.getElementById('next-story').addEventListener('click', () => {
        playUISound('click');
        pauseStoryAutoplay();
        nextStoryPage();
      });
      
      document.getElementById('read-story').addEventListener('click', () => {
        playUISound('click');
        toggleStoryAutoplay();
      });
    }

    function displayStoryPage() {
      const story = storyState.stories[storyState.currentStory];
      const page = story.pages[storyState.currentPage || 0];
      
      document.getElementById('story-emoji').textContent = page.emoji;
      document.getElementById('story-text').textContent = page.text;
      
      // Automatically read the current page
      if (storyState.isPlaying && gameState.settings.speech) {
        readStoryPage();
      }
    }

    function prevStoryPage() {
      if (storyState.currentPage <= 0) {
        // At first page, go to previous story
        if (storyState.currentStory > 0) {
          storyState.currentStory--;
          storyState.currentPage = storyState.stories[storyState.currentStory].pages.length - 1;
        }
      } else {
        storyState.currentPage--;
      }
      
      displayStoryPage();
    }

    function nextStoryPage() {
      const story = storyState.stories[storyState.currentStory];
      
      if (storyState.currentPage < story.pages.length - 1) {
        storyState.currentPage++;
        displayStoryPage();
      } else {
        // At last page, go to next story
        if (storyState.currentStory < storyState.stories.length - 1) {
          storyState.currentStory++;
          storyState.currentPage = 0;
          displayStoryPage();
        } else {
          // Reached the end of all stories, restart from beginning
          storyState.currentStory = 0;
          storyState.currentPage = 0;
          displayStoryPage();
        }
      }
    }

    function readStoryPage() {
      const story = storyState.stories[storyState.currentStory];
      const page = story.pages[storyState.currentPage || 0];
      
      if (gameState.settings.speech) {
        speakColor(page.text);
      }
    }

    function startStoryAutoplay() {
      // Clear any existing timer
      if (storyState.autoPlayTimer) {
        clearTimeout(storyState.autoPlayTimer);
      }
      
      storyState.isPlaying = true;
      displayStoryPage(); // Display and read the current page
      
      // Set up the autoplay timer for next page
      storyState.autoPlayTimer = setTimeout(() => {
        nextStoryPage();
        
        // If we still have pages to go through, continue autoplay
        if (storyState.isPlaying) {
          startStoryAutoplay();
        }
      }, storyState.autoPlayDelay);
      
      // Update button text
      const readButton = document.getElementById('read-story');
      if (readButton) {
        readButton.textContent = "Pause Story";
      }
    }

    function pauseStoryAutoplay() {
      storyState.isPlaying = false;
      
      if (storyState.autoPlayTimer) {
        clearTimeout(storyState.autoPlayTimer);
        storyState.autoPlayTimer = null;
      }
      
      // Cancel any ongoing speech
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      
      // Update button text
      const readButton = document.getElementById('read-story');
      if (readButton) {
        readButton.textContent = "Play Story";
      }
    }

    function toggleStoryAutoplay() {
      if (storyState.isPlaying) {
        pauseStoryAutoplay();
      } else {
        startStoryAutoplay();
      }
    }

    // Helper Functions
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading-animation');
      if (show) {
        loading.classList.add('active');
      } else {
        loading.classList.remove('active');
      }
    }

    // Button Interaction Enhancement
    function addButtonEffects() {
      // Add click feedback to all buttons
      document.querySelectorAll('button, .quiz-option, .mode-card, .menu-item, .category-btn').forEach(btn => {
        btn.addEventListener('mousedown', () => {
          btn.classList.add('button-press');
        });
        
        btn.addEventListener('mouseup', () => {
          btn.classList.remove('button-press');
        });
        
        btn.addEventListener('mouseleave', () => {
          btn.classList.remove('button-press');
        });
        
        // Touch events
        btn.addEventListener('touchstart', () => {
          btn.classList.add('button-press');
        }, { passive: true });
        
        btn.addEventListener('touchend', () => {
          btn.classList.remove('button-press');
        }, { passive: true });
      });
    }
    
    // Add cool haptic feedback if available on device
    function triggerHapticFeedback(intensity = "medium") {
      if (!gameState.settings.haptic) return;
      
      if (navigator.vibrate) {
        switch (intensity) {
          case "light":
            navigator.vibrate(10);
            break;
          case "medium":
            navigator.vibrate([15, 10, 15]);
            break;
          case "strong":
            navigator.vibrate([20, 20, 40]);
            break;
        }
      }
    }
    
    // Enhanced Play Function with Haptic Feedback
    function play(color, name, emoji) {
      // Play sound
      if (gameState.settings.sound) {
        const audio = document.getElementById('sound-' + color);
        if (audio) {
          audio.currentTime = 0;
          audio.play().catch(err => {
            console.log('Audio play failed:', err);
            // Try to play the category sound as fallback
            const categoryAudio = document.getElementById('sound-category-' + gameState.currentCategory.toLowerCase());
            if (categoryAudio) categoryAudio.play().catch(() => {});
          });
        }
      }
      
      // Show star animation
      if (gameState.settings.animations) {
        const star = elements.star;
        star.classList.remove('hidden');
        star.classList.add('show');
        setTimeout(() => star.classList.remove('show'), 900);
      }
      
      // Confetti burst
      if (gameState.settings.animations) {
        confettiBurst(color);
      }
      
      // Haptic feedback
      triggerHapticFeedback("medium");
      
      // Show color popup and speak
      showColorPopup(color, name, emoji);
      
      // Update user progress
      updateUserProgress(color, name);
    }
    
    // Preload Essential Audio
    function preloadEssentialAudio() {
      const essentialSounds = [
        'sound-ui-click',
        'sound-ui-success',
        'sound-ui-transition'
      ];
      
      essentialSounds.forEach(soundId => {
        const sound = document.getElementById(soundId);
        if (sound) {
          sound.load();
        }
      });
    }
    
    // Main Initialization Function
    function initializeGame() {
      loadSettings();
      loadProgress();
      initializeNavigation();
      createAudioElements();
      addButtonEffects();
      
      // Initialize story mode state
      storyState.currentPage = 0;
      storyState.isPlaying = false;
      
      // Make title rainbow for fun
      const welcomeTitle = document.querySelector('.welcome-title');
      if (welcomeTitle) {
        welcomeTitle.classList.add('rainbow-text');
      }
      
      // Preload the most essential audio files
      preloadEssentialAudio();
      
      // Show opening animation
      setTimeout(() => {
        elements.star.classList.remove('hidden');
        elements.star.classList.add('show');
        
        // Add sparkles for opening animation
        addSparkles('yellow');
        
        setTimeout(() => elements.star.classList.remove('show'), 1200);
      }, 500);
    }
    
    // Window resize handler for canvas
    window.addEventListener('resize', () => {
      // Resize paint canvas if in paint mode
      if (gameState.currentScreen === 'paint-mode' && paintCanvas) {
        const canvasContainer = document.querySelector('.canvas-container');
        if (canvasContainer) {
          // Save the current drawing
          const imageData = paintCtx.getImageData(0, 0, paintCanvas.width, paintCanvas.height);
          
          // Resize canvas
          paintCanvas.width = canvasContainer.offsetWidth;
          paintCanvas.height = canvasContainer.offsetHeight;
          
          // Restore canvas settings
          paintCtx.lineCap = 'round';
          paintCtx.lineWidth = 15;
          paintCtx.strokeStyle = currentColor;
          
          // Draw a white background
          paintCtx.fillStyle = 'white';
          paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
          
          // Try to restore the previous drawing (might be stretched)
          try {
            paintCtx.putImageData(imageData, 0, 0);
          } catch (e) {
            console.log('Could not restore canvas content on resize:', e);
          }
        }
      }
    });

    // Initialize the game when the page loads
    document.addEventListener('DOMContentLoaded', initializeGame);

    // Match Mode Functionality
    const matchState = {
      cards: [],
      flippedCards: [],
      matchedPairs: 0,
      totalPairs: 0,
      timerInterval: null,
      timeElapsed: 0,
      level: 'easy',
      isGameActive: false
    };

    function initializeMatchMode() {
      // Clear any previous game state
      clearMatchGame();
      
      // Set up level selection
      const levelSelect = document.getElementById('match-level');
      levelSelect.value = matchState.level;
      levelSelect.addEventListener('change', function() {
        matchState.level = this.value;
        startNewMatchGame();
      });
      
      // Set up new game button
      document.getElementById('new-match-game').addEventListener('click', () => {
        playUISound('click');
        startNewMatchGame();
      });
      
      // Start a new game automatically
      startNewMatchGame();
    }

    function startNewMatchGame() {
      // Clear previous game
      clearMatchGame();
      
      // Reset game state
      matchState.flippedCards = [];
      matchState.matchedPairs = 0;
      matchState.timeElapsed = 0;
      matchState.isGameActive = true;
      
      // Update UI
      document.getElementById('match-score').textContent = `Matches: 0`;
      document.getElementById('match-timer').textContent = `Time: 0`;
      
      // Determine card count based on level
      let pairCount;
      switch (matchState.level) {
        case 'easy':
          pairCount = 6; // 12 cards total
          break;
        case 'medium':
          pairCount = 8; // 16 cards total
          break;
        case 'hard':
          pairCount = 10; // 20 cards total
          break;
        default:
          pairCount = 6;
      }
      
      matchState.totalPairs = pairCount;
      
      // Create card data (color pairs)
      const colorPairs = [];
      const allColors = [];
      
      // Gather all unique colors from our colorCategories
      Object.values(colorCategories).forEach(category => {
        category.forEach(item => {
          if (!allColors.some(c => c.color === item.color)) {
            allColors.push(item);
          }
        });
      });
      
      // Shuffle and pick the number of pairs we need
      shuffleArray(allColors);
      const selectedColors = allColors.slice(0, pairCount);
      
      // Create pairs
      selectedColors.forEach(colorItem => {
        // Add each color twice (as a pair)
        colorPairs.push({
          id: `card-${colorItem.color}-1`,
          color: colorItem.color,
          name: colorItem.name,
          emoji: colorItem.emoji,
          matched: false
        });
        
        colorPairs.push({
          id: `card-${colorItem.color}-2`,
          color: colorItem.color,
          name: colorItem.name,
          emoji: colorItem.emoji,
          matched: false
        });
      });
      
      // Shuffle the pairs
      shuffleArray(colorPairs);
      matchState.cards = colorPairs;
      
      // Render cards
      renderMatchCards();
      
      // Start timer
      startMatchTimer();
    }

    function renderMatchCards() {
      const boardElement = document.getElementById('match-board');
      boardElement.innerHTML = '';
      
      // Adjust grid columns based on level
      switch (matchState.level) {
        case 'easy':
          boardElement.style.gridTemplateColumns = 'repeat(4, 1fr)';
          break;
        case 'medium':
          boardElement.style.gridTemplateColumns = 'repeat(4, 1fr)';
          break;
        case 'hard':
          boardElement.style.gridTemplateColumns = 'repeat(5, 1fr)';
          break;
      }
      
      // Create card elements
      matchState.cards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'match-card';
        cardElement.id = card.id;
        
        const cardFront = document.createElement('div');
        cardFront.className = 'match-card-front';
        cardFront.textContent = '?';
        
        const cardBack = document.createElement('div');
        cardBack.className = 'match-card-back';
        cardBack.innerHTML = card.emoji;
        cardBack.style.background = colorGradients[card.color] || card.color;
        
        cardElement.appendChild(cardFront);
        cardElement.appendChild(cardBack);
        
        cardElement.addEventListener('click', () => {
          if (!matchState.isGameActive) return;
          if (card.matched) return;
          if (matchState.flippedCards.length >= 2) return;
          if (matchState.flippedCards.some(c => c.id === card.id)) return;
          
          // Flip the card
          cardElement.classList.add('flipped');
          playUISound('click');
          
          // Add to flipped cards
          matchState.flippedCards.push(card);
          
          // Check for match if we have 2 flipped cards
          if (matchState.flippedCards.length === 2) {
            setTimeout(checkForMatch, 800);
          }
        });
        
        boardElement.appendChild(cardElement);
      });
    }

    function checkForMatch() {
      if (matchState.flippedCards.length !== 2) return;
      
      const [card1, card2] = matchState.flippedCards;
      
      if (card1.color === card2.color) {
        // Match found!
        matchState.matchedPairs++;
        matchState.cards.find(c => c.id === card1.id).matched = true;
        matchState.cards.find(c => c.id === card2.id).matched = true;
        
        // Update UI
        document.getElementById('match-score').textContent = `Matches: ${matchState.matchedPairs}`;
        
        // Play success sound
        playUISound('success');
        
        // Show success effect
        const card1Element = document.getElementById(card1.id);
        const card2Element = document.getElementById(card2.id);
        
        card1Element.style.animation = 'success-pulse 1s';
        card2Element.style.animation = 'success-pulse 1s';
        
        setTimeout(() => {
          card1Element.style.animation = '';
          card2Element.style.animation = '';
        }, 1000);
        
        // Show color name popup
        showColorPopup(card1.color, card1.name, card1.emoji);
        
        // Check for game completion
        if (matchState.matchedPairs === matchState.totalPairs) {
          gameCompleted();
        }
      } else {
        // No match, flip cards back
        const card1Element = document.getElementById(card1.id);
        const card2Element = document.getElementById(card2.id);
        
        setTimeout(() => {
          card1Element.classList.remove('flipped');
          card2Element.classList.remove('flipped');
          playUISound('error');
        }, 300);
      }
      
      // Reset flipped cards
      matchState.flippedCards = [];
    }

    function startMatchTimer() {
      // Clear any existing timer
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
      }
      
      matchState.timeElapsed = 0;
      document.getElementById('match-timer').textContent = `Time: ${matchState.timeElapsed}`;
      
      matchState.timerInterval = setInterval(() => {
        if (!matchState.isGameActive) return;
        
        matchState.timeElapsed++;
        document.getElementById('match-timer').textContent = `Time: ${matchState.timeElapsed}`;
      }, 1000);
    }

    function clearMatchGame() {
      // Clear the board
      const boardElement = document.getElementById('match-board');
      if (boardElement) boardElement.innerHTML = '';
      
      // Clear the timer
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
        matchState.timerInterval = null;
      }
      
      matchState.isGameActive = false;
    }

    function gameCompleted() {
      matchState.isGameActive = false;
      
      // Stop the timer
      if (matchState.timerInterval) {
        clearInterval(matchState.timerInterval);
        matchState.timerInterval = null;
      }
      
      // Celebrate!
      confettiBurst('rainbow');
      
      // Show completion message
      const completionMessage = document.createElement('div');
      completionMessage.className = 'game-completion-message';
      completionMessage.innerHTML = `
        <div class="completion-title">Awesome!</div>
        <div class="completion-details">
          You matched all the colors in ${matchState.timeElapsed} seconds!
        </div>
        <button class="completion-btn">Play Again</button>
      `;
      
      document.querySelector('.match-container').appendChild(completionMessage);
      
      // Add play again button handler
      completionMessage.querySelector('.completion-btn').addEventListener('click', () => {
        completionMessage.remove();
        startNewMatchGame();
      });
      
      // Add achievement if completed under certain time
      const timeThreshold = matchState.level === 'easy' ? 30 : 
                           matchState.level === 'medium' ? 60 : 90;
      
      if (matchState.timeElapsed < timeThreshold) {
        if (!gameState.userProgress.achievements.includes('match_master')) {
          gameState.userProgress.achievements.push('match_master');
          saveProgress();
          showAchievement('Match Master!');
        }
      }
    }

    // Dance Mode Functionality
    const danceState = {
      currentDancer: 'üß∏',
      dancers: ['üß∏', 'üêª', 'üê±', 'üê∂', 'üê∞', 'ü¶ä', 'üêµ', 'ü¶Å', 'üêº', 'üêØ'],
      musicPlaying: true,
      currentAudio: null,
      dancesPerformed: 0
    };

    function initializeDanceMode() {
      // Set up the dancer
      const dancer = document.getElementById('main-dancer');
      dancer.textContent = danceState.currentDancer;
      
      // Create color buttons
      createDanceColorButtons();
      
      // Set up dancer change button
      document.getElementById('change-dancer').addEventListener('click', () => {
        playUISound('click');
        changeDancer();
      });
      
      // Set up music toggle button
      document.getElementById('dance-music-toggle').addEventListener('click', () => {
        toggleDanceMusic();
      });
      
      // Reset dance count
      danceState.dancesPerformed = 0;
      
      // Start background music
      if (danceState.musicPlaying) {
        playDanceMusic();
      }
    }

    function createDanceColorButtons() {
      const colorsContainer = document.getElementById('dance-colors');
      colorsContainer.innerHTML = '';
      
      // Get 8 random colors from our color categories
      const allColors = [];
      Object.values(colorCategories).forEach(category => {
        category.forEach(item => {
          if (!allColors.some(c => c.color === item.color)) {
            allColors.push(item);
          }
        });
      });
      
      shuffleArray(allColors);
      const selectedColors = allColors.slice(0, 8);
      
      // Create color buttons
      selectedColors.forEach(colorItem => {
        const colorButton = document.createElement('div');
        colorButton.className = 'dance-color';
        colorButton.style.background = colorGradients[colorItem.color] || colorItem.color;
        colorButton.setAttribute('data-color', colorItem.color);
        colorButton.setAttribute('data-name', colorItem.name);
        colorButton.setAttribute('data-emoji', colorItem.emoji);
        
        colorButton.addEventListener('click', () => {
          makeDancerDance(colorItem.color, colorItem.name, colorItem.emoji);
        });
        
        colorsContainer.appendChild(colorButton);
      });
    }

    function makeDancerDance(color, name, emoji) {
      const dancer = document.getElementById('main-dancer');
      
      // Stop any existing animation
      dancer.classList.remove('dance-animation');
      void dancer.offsetWidth; // Trigger reflow to restart animation
      
      // Make dancer dance
      dancer.classList.add('dance-animation');
      
      // Change stage background color
      const stage = document.getElementById('dance-stage');
      stage.style.background = `linear-gradient(to bottom, ${color}, #ffe34b)`;
      
      // Play sound
      playUISound('click');
      
      // Show color popup
      showColorPopup(color, name, emoji);
      
      // Add sparkles
      addDanceSparkles(color);
      
      // Track progress
      danceState.dancesPerformed++;
      
      // Check for achievements
      if (danceState.dancesPerformed >= 10) {
        if (!gameState.userProgress.achievements.includes('dance_star')) {
          gameState.userProgress.achievements.push('dance_star');
          saveProgress();
          showAchievement('Dance Star!');
        }
      }
    }

    function changeDancer() {
      // Get the next dancer
      const currentIndex = danceState.dancers.indexOf(danceState.currentDancer);
      const nextIndex = (currentIndex + 1) % danceState.dancers.length;
      danceState.currentDancer = danceState.dancers[nextIndex];
      
      // Update the dancer
      const dancer = document.getElementById('main-dancer');
      
      // Add a little animation
      dancer.style.transform = 'translateX(-50%) scale(0)';
      
      setTimeout(() => {
        dancer.textContent = danceState.currentDancer;
        dancer.style.transform = 'translateX(-50%) scale(1)';
      }, 300);
    }

    function toggleDanceMusic() {
      danceState.musicPlaying = !danceState.musicPlaying;
      
      // Update the button text
      const musicButton = document.getElementById('dance-music-toggle');
      musicButton.textContent = `Music: ${danceState.musicPlaying ? 'ON' : 'OFF'}`;
      
      // Play or stop the music
      if (danceState.musicPlaying) {
        playDanceMusic();
      } else {
        stopDanceMusic();
      }
    }

    function playDanceMusic() {
      if (!gameState.settings.sound) return;
      
      if (danceState.currentAudio) {
        danceState.currentAudio.pause();
      }
      
      // Create a new audio element for dance music
      danceState.currentAudio = new Audio('https://cdn.pixabay.com/audio/2022/11/17/audio_8130e9d75f.mp3');
      danceState.currentAudio.loop = true;
      danceState.currentAudio.volume = 0.5;
      danceState.currentAudio.play().catch(err => console.log('Dance music play failed:', err));
    }

    function stopDanceMusic() {
      if (danceState.currentAudio) {
        danceState.currentAudio.pause();
      }
    }

    function addDanceSparkles(color) {
      const stage = document.getElementById('dance-stage');
      
      // Create multiple sparkles at different locations
      for (let i = 0; i < 15; i++) {
        setTimeout(() => {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle ' + ['sparkle-sm', 'sparkle-md', 'sparkle-lg'][Math.floor(Math.random() * 3)];
          
          // Convert color name to CSS color if needed
          let sparkleColor = color;
          if (typeof color === 'string' && !color.includes('#') && !color.includes('rgb')) {
            sparkleColor = colorGradients[color] ? colorGradients[color].split(',')[0].split('(')[1] : color;
          }
          
          sparkle.style.background = sparkleColor;
          
          // Random position around the dancer
          sparkle.style.left = (40 + Math.random() * 20) + '%';
          sparkle.style.top = (40 + Math.random() * 40) + '%';
          
          stage.appendChild(sparkle);
          
          // Remove after animation completes
          setTimeout(() => sparkle.remove(), 1000);
        }, Math.random() * 700); // Stagger the sparkles
      }
    }

    // Peek-a-boo Mode Functionality
    const peekabooState = {
      colors: [],
      visibleItems: [],
      totalFound: 0,
      totalItems: 8,
      gameActive: false,
      speed: 'slow',
      speedValues: {
        slow: 3000,
        medium: 2000,
        fast: 1000
      },
      showTimeout: null
    };

    function initializePeekabooMode() {
      // Set up the game
      updatePeekabooScore();
      
      // Set up speed buttons
      const speedButtons = document.querySelectorAll('.peekaboo-speed-btn');
      speedButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update speed setting
          peekabooState.speed = btn.getAttribute('data-speed');
          
          // Update active button
          speedButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Restart game if active
          if (peekabooState.gameActive) {
            stopPeekabooGame();
            startPeekabooGame();
          }
        });
      });
      
      // Set up start button
      document.getElementById('peekaboo-start').addEventListener('click', () => {
        playUISound('click');
        if (peekabooState.gameActive) {
          stopPeekabooGame();
        } else {
          startPeekabooGame();
        }
      });
      
      // Initial instruction display
      const stage = document.getElementById('peekaboo-stage');
      stage.innerHTML = '<div class="peekaboo-instruction">Press Start to play Peek-a-boo with colors!</div>';
    }

    function startPeekabooGame() {
      // Reset game state
      peekabooState.totalFound = 0;
      peekabooState.visibleItems = [];
      peekabooState.gameActive = true;
      
      // Update start button
      document.getElementById('peekaboo-start').textContent = 'Stop Game';
      
      // Clear stage
      const stage = document.getElementById('peekaboo-stage');
      stage.innerHTML = '';
      
      // Get colors for the game
      selectPeekabooColors();
      
      // Start showing items
      showNextPeekabooItem();
      
      // Update score
      updatePeekabooScore();
    }

    function stopPeekabooGame() {
      peekabooState.gameActive = false;
      
      // Clear any pending timeouts
      if (peekabooState.showTimeout) {
        clearTimeout(peekabooState.showTimeout);
      }
      
      // Update button
      document.getElementById('peekaboo-start').textContent = 'Start New Game';
      
      // Clear stage
      const stage = document.getElementById('peekaboo-stage');
      stage.innerHTML = '<div class="peekaboo-instruction">Game stopped. Press Start to play again!</div>';
    }

    function selectPeekabooColors() {
      peekabooState.colors = [];
      
      // Get all unique colors from our color categories
      const allColors = [];
      Object.values(colorCategories).forEach(category => {
        category.forEach(item => {
          if (!allColors.some(c => c.color === item.color)) {
            allColors.push(item);
          }
        });
      });
      
      // Shuffle and select colors
      shuffleArray(allColors);
      peekabooState.colors = allColors.slice(0, peekabooState.totalItems);
    }

    function showNextPeekabooItem() {
      if (!peekabooState.gameActive) return;
      
      // If all items are visible, hide one
      if (peekabooState.visibleItems.length >= 3) {
        hideRandomPeekabooItem();
      }
      
      // Get a random color not currently visible
      const availableColors = peekabooState.colors.filter(
        c => !peekabooState.visibleItems.includes(c.color)
      );
      
      if (availableColors.length === 0) return;
      
      const colorItem = availableColors[Math.floor(Math.random() * availableColors.length)];
      
      // Add to visible items
      peekabooState.visibleItems.push(colorItem.color);
      
      // Create and show the item
      createPeekabooItem(colorItem);
      
      // Schedule next item
      const speedValue = peekabooState.speedValues[peekabooState.speed];
      peekabooState.showTimeout = setTimeout(showNextPeekabooItem, speedValue);
    }

    function createPeekabooItem(colorItem) {
      const stage = document.getElementById('peekaboo-stage');
      
      // Create item
      const item = document.createElement('div');
      item.className = 'peekaboo-item';
      item.setAttribute('data-color', colorItem.color);
      item.style.background = colorGradients[colorItem.color] || colorItem.color;
      item.innerHTML = colorItem.emoji;
      
      // Random position
      item.style.left = (10 + Math.random() * 80) + '%';
      item.style.top = (10 + Math.random() * 80) + '%';
      
      // Add to stage
      stage.appendChild(item);
      
      // Make visible with a delay
      setTimeout(() => {
        item.classList.add('visible');
      }, 100);
      
      // Add click handler
      item.addEventListener('click', () => {
        if (!peekabooState.gameActive) return;
        findPeekabooItem(item, colorItem);
      });
    }

    function hideRandomPeekabooItem() {
      if (peekabooState.visibleItems.length === 0) return;
      
      // Get a random visible item
      const randomIndex = Math.floor(Math.random() * peekabooState.visibleItems.length);
      const colorToHide = peekabooState.visibleItems[randomIndex];
      
      // Remove from visible items
      peekabooState.visibleItems.splice(randomIndex, 1);
      
      // Find and hide the DOM element
      const items = document.querySelectorAll('.peekaboo-item');
      items.forEach(item => {
        if (item.getAttribute('data-color') === colorToHide) {
          item.classList.remove('visible');
          
          // Remove after fade out
          setTimeout(() => {
            if (item.parentNode) {
              item.parentNode.removeChild(item);
            }
          }, 500);
        }
      });
    }

    function findPeekabooItem(itemElement, colorItem) {
      // Item found!
      itemElement.classList.add('found');
      
      // Remove from visible items
      const colorIndex = peekabooState.visibleItems.indexOf(colorItem.color);
      if (colorIndex !== -1) {
        peekabooState.visibleItems.splice(colorIndex, 1);
      }
      
      // Play sound
      playUISound('success');
      
      // Show color popup
      showColorPopup(colorItem.color, colorItem.name, colorItem.emoji);
      
      // Update score
      peekabooState.totalFound++;
      updatePeekabooScore();
      
      // Check for achievement
      if (peekabooState.totalFound >= 15) {
        if (!gameState.userProgress.achievements.includes('peek_master')) {
          gameState.userProgress.achievements.push('peek_master');
          saveProgress();
          showAchievement('Peek-a-boo Master!');
        }
      }
      
      // Remove the item after animation
      setTimeout(() => {
        if (itemElement.parentNode) {
          itemElement.parentNode.removeChild(itemElement);
        }
      }, 500);
    }

    function updatePeekabooScore() {
      document.getElementById('peekaboo-score').textContent = `Found: ${peekabooState.totalFound}`;
    }

    // Count Mode Functionality
    const countState = {
      score: 0,
      currentCount: 0,
      currentColor: null,
      currentEmoji: null,
      colorOptions: [],
      isCheckingAnswer: false
    };

    function initializeCountMode() {
      // Reset score
      countState.score = 0;
      updateCountScore();
      
      // Set up next button
      document.getElementById('count-next').addEventListener('click', () => {
        if (!countState.isCheckingAnswer) {
          playUISound('click');
          generateCountQuestion();
        }
      });
      
      // Set up number buttons
      const numberButtons = document.querySelectorAll('.count-number-btn');
      numberButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          if (countState.isCheckingAnswer) return;
          
          const number = parseInt(btn.getAttribute('data-number'));
          checkCountAnswer(number);
        });
      });
      
      // Generate first question
      generateCountQuestion();
    }

    function generateCountQuestion() {
      // Clear previous objects
      const objectsContainer = document.getElementById('count-objects');
      objectsContainer.innerHTML = '';
      
      // Add feedback element if needed
      if (!document.querySelector('.count-feedback')) {
        const feedback = document.createElement('div');
        feedback.className = 'count-feedback';
        document.getElementById('count-stage').appendChild(feedback);
      }
      
      // Get all unique colors from our color categories
      if (countState.colorOptions.length === 0) {
        const allColors = [];
        Object.values(colorCategories).forEach(category => {
          category.forEach(item => {
            if (!allColors.some(c => c.color === item.color)) {
              allColors.push(item);
            }
          });
        });
        countState.colorOptions = allColors;
      }
      
      // Select a random color
      const colorItem = countState.colorOptions[Math.floor(Math.random() * countState.colorOptions.length)];
      countState.currentColor = colorItem.color;
      countState.currentEmoji = colorItem.emoji;
      
      // Determine count (1-3)
      countState.currentCount = Math.floor(Math.random() * 3) + 1;
      
      // Create objects
      for (let i = 0; i < countState.currentCount; i++) {
        const object = document.createElement('div');
        object.className = 'count-object';
        object.textContent = colorItem.emoji;
        object.style.animationDelay = `${i * 0.2}s`;
        
        // Add to container
        objectsContainer.appendChild(object);
      }
      
      // Update question
      document.getElementById('count-question').textContent = `How many ${colorItem.name} ${colorItem.emoji} do you see?`;
      
      countState.isCheckingAnswer = false;
    }

    function checkCountAnswer(answer) {
      countState.isCheckingAnswer = true;
      
      const isCorrect = answer === countState.currentCount;
      const feedback = document.querySelector('.count-feedback');
      
      if (isCorrect) {
        // Update score
        countState.score++;
        updateCountScore();
        
        // Show success feedback
        feedback.textContent = '‚úì';
        feedback.style.color = 'green';
        playUISound('success');
        
        // Show color popup
        showColorPopup(countState.currentColor, String(countState.currentCount), countState.currentEmoji);
        
        // Celebrate
        if (countState.score % 5 === 0) {
          confettiBurst('rainbow');
        }
      } else {
        // Show error feedback
        feedback.textContent = '‚úó';
        feedback.style.color = 'red';
        playUISound('error');
      }
      
      // Animate feedback
      feedback.classList.remove('show');
      void feedback.offsetWidth; // Trigger reflow
      feedback.classList.add('show');
      
      // Move to next question after delay
      setTimeout(() => {
        if (isCorrect) {
          generateCountQuestion();
        } else {
          countState.isCheckingAnswer = false;
        }
      }, 1500);
      
      // Check for achievement
      if (countState.score >= 10) {
        if (!gameState.userProgress.achievements.includes('counting_star')) {
          gameState.userProgress.achievements.push('counting_star');
          saveProgress();
          showAchievement('Counting Star!');
        }
      }
    }

    function updateCountScore() {
      document.getElementById('count-score').textContent = `Score: ${countState.score}`;
    }

    // Bubbles Mode Functionality
    const bubblesState = {
      bubbles: [],
      popped: 0,
      isActive: false,
      bubblesAmount: 'few',
      amountValues: {
        few: 5,
        many: 10,
        lots: 15
      },
      createInterval: null,
      colors: []
    };

    function initializeBubblesMode() {
      // Reset state
      bubblesState.popped = 0;
      updateBubblesScore();
      
      // Set up start button
      document.getElementById('bubbles-start').addEventListener('click', () => {
        playUISound('click');
        if (bubblesState.isActive) {
          stopBubbles();
        } else {
          startBubbles();
        }
      });
      
      // Set up amount buttons
      const amountButtons = document.querySelectorAll('.bubbles-amount-btn');
      amountButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update amount setting
          bubblesState.bubblesAmount = btn.getAttribute('data-amount');
          
          // Update active button
          amountButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Restart if active
          if (bubblesState.isActive) {
            stopBubbles();
            startBubbles();
          }
        });
      });
      
      // Initialize colors
      if (bubblesState.colors.length === 0) {
        const allColors = [];
        Object.values(colorCategories).forEach(category => {
          category.forEach(item => {
            if (!allColors.some(c => c.color === item.color)) {
              allColors.push(item);
            }
          });
        });
        bubblesState.colors = allColors;
      }
      
      // Initial state
      const stage = document.getElementById('bubbles-stage');
      stage.innerHTML = '<div class="bubbles-instruction" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; color: #fff; text-align: center;">Press Start to play with bubbles!</div>';
    }

    function startBubbles() {
      bubblesState.isActive = true;
      
      // Update button
      document.getElementById('bubbles-start').textContent = 'Stop Game';
      
      // Clear stage
      const stage = document.getElementById('bubbles-stage');
      stage.innerHTML = '';
      
      // Start creating bubbles
      createBubbles();
      
      // Set interval for creating bubbles
      bubblesState.createInterval = setInterval(createBubbles, 3000);
    }

    function stopBubbles() {
      bubblesState.isActive = false;
      
      // Clear interval
      if (bubblesState.createInterval) {
        clearInterval(bubblesState.createInterval);
        bubblesState.createInterval = null;
      }
      
      // Update button
      document.getElementById('bubbles-start').textContent = 'Start Game';
      
      // Clear stage
      const stage = document.getElementById('bubbles-stage');
      stage.innerHTML = '<div class="bubbles-instruction" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; color: #fff; text-align: center;">Game stopped. Press Start to play again!</div>';
      
      // Reset bubbles array
      bubblesState.bubbles = [];
    }

    function createBubbles() {
      if (!bubblesState.isActive) return;
      
      const stage = document.getElementById('bubbles-stage');
      const stageWidth = stage.offsetWidth;
      const stageHeight = stage.offsetHeight;
      
      // Determine number of bubbles to create
      const bubbleCount = bubblesState.amountValues[bubblesState.bubblesAmount];
      
      // Create bubbles
      for (let i = 0; i < bubbleCount; i++) {
        // Get random color
        const colorItem = bubblesState.colors[Math.floor(Math.random() * bubblesState.colors.length)];
        
        // Create bubble
        const size = 40 + Math.random() * 40; // 40-80px
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        
        // Apply color
        bubble.style.borderColor = colorItem.color;
        bubble.innerHTML = colorItem.emoji;
        bubble.setAttribute('data-color', colorItem.color);
        bubble.setAttribute('data-name', colorItem.name);
        bubble.setAttribute('data-emoji', colorItem.emoji);
        
        // Random position
        const left = Math.random() * (stageWidth - size);
        const top = Math.random() * (stageHeight - size);
        bubble.style.left = `${left}px`;
        bubble.style.top = `${top}px`;
        
        // Animation
        const duration = 5 + Math.random() * 5;
        bubble.style.animationDuration = `${duration}s`;
        
        // Click handler
        bubble.addEventListener('click', () => {
          if (!bubblesState.isActive) return;
          popBubble(bubble, colorItem);
        });
        
        // Add to stage
        stage.appendChild(bubble);
        
        // Add to bubbles array
        bubblesState.bubbles.push({
          element: bubble,
          color: colorItem.color,
          name: colorItem.name,
          emoji: colorItem.emoji
        });
        
        // Remove after duration
        setTimeout(() => {
          if (bubble.parentNode) {
            bubble.parentNode.removeChild(bubble);
            
            // Remove from bubbles array
            const index = bubblesState.bubbles.findIndex(b => b.element === bubble);
            if (index !== -1) {
              bubblesState.bubbles.splice(index, 1);
            }
          }
        }, duration * 1000);
      }
    }

    function popBubble(bubbleElement, colorItem) {
      // Add popping animation
      bubbleElement.classList.add('popping');
      
      // Play sound
      playUISound('click');
      
      // Show color popup
      showColorPopup(colorItem.color, colorItem.name, colorItem.emoji);
      
      // Update score
      bubblesState.popped++;
      updateBubblesScore();
      
      // Remove bubble after animation
      setTimeout(() => {
        if (bubbleElement.parentNode) {
          bubbleElement.parentNode.removeChild(bubbleElement);
          
          // Remove from bubbles array
          const index = bubblesState.bubbles.findIndex(b => b.element === bubbleElement);
          if (index !== -1) {
            bubblesState.bubbles.splice(index, 1);
          }
        }
      }, 300);
      
      // Check for achievement
      if (bubblesState.popped >= 20) {
        if (!gameState.userProgress.achievements.includes('bubble_master')) {
          gameState.userProgress.achievements.push('bubble_master');
          saveProgress();
          showAchievement('Bubble Master!');
        }
      }
    }

    function updateBubblesScore() {
      document.getElementById('bubbles-score').textContent = `Popped: ${bubblesState.popped}`;
    }

    // Shapes Mode Functionality
    const shapesState = {
      currentShapeType: 'all',
      shapes: {
        basic: [
          { name: 'Circle', svg: '<circle cx="60" cy="60" r="50" />', color: 'red' },
          { name: 'Square', svg: '<rect x="10" y="10" width="100" height="100" />', color: 'blue' },
          { name: 'Triangle', svg: '<polygon points="60,10 110,110 10,110" />', color: 'green' },
          { name: 'Rectangle', svg: '<rect x="10" y="30" width="100" height="60" />', color: 'purple' },
          { name: 'Oval', svg: '<ellipse cx="60" cy="60" rx="55" ry="35" />', color: 'orange' }
        ],
        complex: [
          { name: 'Star', svg: '<polygon points="60,10 75,50 120,50 85,75 95,115 60,90 25,115 35,75 0,50 45,50" />', color: 'yellow' },
          { name: 'Heart', svg: '<path d="M60,110 C100,80 120,40 60,15 C0,40 20,80 60,110 Z" />', color: 'pink' },
          { name: 'Diamond', svg: '<polygon points="60,10 110,60 60,110 10,60" />', color: 'cyan' },
          { name: 'Hexagon', svg: '<polygon points="110,60 85,110 35,110 10,60 35,10 85,10" />', color: 'lime' },
          { name: 'Crescent', svg: '<path d="M50,10 A50,50 0 1,1 50,110 A40,40 0 1,0 50,10 Z" />', color: 'gold' }
        ]
      },
      learnedShapes: []
    };

    function initializeShapesMode() {
      // Set up shape type buttons
      const shapeTypeButtons = document.querySelectorAll('.shape-type-btn');
      shapeTypeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update shape type
          shapesState.currentShapeType = btn.getAttribute('data-shape');
          
          // Update active button
          shapeTypeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Render shapes
          renderShapes();
          
          // Play sound
          playUISound('click');
        });
      });
      
      // Initial render
      renderShapes();
    }

    function renderShapes() {
      const shapesBoard = document.getElementById('shapes-board');
      shapesBoard.innerHTML = '';
      
      // Determine which shapes to display
      let shapesToDisplay = [];
      if (shapesState.currentShapeType === 'all') {
        shapesToDisplay = [...shapesState.shapes.basic, ...shapesState.shapes.complex];
      } else {
        shapesToDisplay = shapesState.shapes[shapesState.currentShapeType];
      }
      
      // Shuffle the shapes for variety
      shuffleArray(shapesToDisplay);
      
      // Create shape items
      shapesToDisplay.forEach(shape => {
        const shapeItem = document.createElement('div');
        shapeItem.className = 'shape-item';
        
        // SVG container
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 120 120');
        svg.innerHTML = shape.svg;
        
        // Apply color
        const svgShape = svg.querySelector('*');
        svgShape.setAttribute('fill', shape.color);
        svgShape.setAttribute('stroke', '#333');
        svgShape.setAttribute('stroke-width', '2');
        
        // Add shape name
        const shapeName = document.createElement('div');
        shapeName.className = 'shape-name';
        shapeName.textContent = shape.name;
        
        // Add to shape item
        shapeItem.appendChild(svg);
        shapeItem.appendChild(shapeName);
        
        // Add click handler
        shapeItem.addEventListener('click', () => {
          learnShape(shape);
        });
        
        // Add to board
        shapesBoard.appendChild(shapeItem);
      });
    }

    function learnShape(shape) {
      // Animate the shape
      const shapeItems = document.querySelectorAll('.shape-item');
      let clickedShape;
      
      shapeItems.forEach(item => {
        if (item.querySelector('.shape-name').textContent === shape.name) {
          clickedShape = item;
          item.style.transform = 'scale(1.2)';
          setTimeout(() => {
            item.style.transform = '';
          }, 500);
        }
      });
      
      // Play sound
      playUISound('click');
      
      // Show color and shape name
      showColorPopup(shape.color, `${shape.name} Shape`, 'üîµ');
      
      // Update learned shapes
      if (!shapesState.learnedShapes.includes(shape.name)) {
        shapesState.learnedShapes.push(shape.name);
        
        // Check for achievement
        if (shapesState.learnedShapes.length >= 8) {
          if (!gameState.userProgress.achievements.includes('shape_master')) {
            gameState.userProgress.achievements.push('shape_master');
            saveProgress();
            showAchievement('Shape Master!');
          }
        }
      }
      
      // Add sparkle effect
      if (clickedShape) {
        addShapeSparkles(clickedShape, shape.color);
      }
      
      // Speak the shape name
      if (gameState.settings.speech) {
        speakColor(`${shape.name} Shape`);
      }
    }

    function addShapeSparkles(shapeElement, color) {
      // Create sparkles around the shape
      for (let i = 0; i < 10; i++) {
        setTimeout(() => {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle ' + 
            ['sparkle-sm', 'sparkle-md', 'sparkle-lg'][Math.floor(Math.random() * 3)];
          
          // Use the shape's color for sparkles
          sparkle.style.background = color;
          
          // Position sparkle relative to shape element
          const rect = shapeElement.getBoundingClientRect();
          const boardRect = document.getElementById('shapes-board').getBoundingClientRect();
          
          // Position relative to the shapes-board
          const left = rect.left - boardRect.left + Math.random() * rect.width;
          const top = rect.top - boardRect.top + Math.random() * rect.height;
          
          sparkle.style.left = left + 'px';
          sparkle.style.top = top + 'px';
          
          // Add to shapes board
          document.getElementById('shapes-board').appendChild(sparkle);
          
          // Remove after animation
          setTimeout(() => sparkle.remove(), 1000);
        }, Math.random() * 500);
      }
    }

    // Music Mode Functionality
    const musicState = {
      currentInstrument: 'piano',
      instruments: ['piano', 'guitar', 'drum', 'trumpet', 'violin'],
      instrumentEmojis: {
        piano: 'üéπ',
        guitar: 'üé∏',
        drum: 'ü•Å',
        trumpet: 'üé∫',
        violin: 'üéª'
      },
      notes: [],
      isPlayingSong: false,
      songTimeout: null
    };

    function initializeMusicMode() {
      // Create color-based music keys
      createMusicKeys();
      
      // Set up instrument change button
      document.getElementById('change-instrument').addEventListener('click', () => {
        playUISound('click');
        changeInstrument();
      });
      
      // Set up play song button
      document.getElementById('play-song').addEventListener('click', () => {
        playUISound('click');
        playSong();
      });
      
      // Initialize instrument display
      document.getElementById('music-instrument').textContent = musicState.instrumentEmojis[musicState.currentInstrument];
    }

    function createMusicKeys() {
      const keysContainer = document.getElementById('music-keys');
      keysContainer.innerHTML = '';
      
      // Get 8 colors for our piano keys
      const colors = [
        { name: 'Red', color: 'red', note: 'C' },
        { name: 'Orange', color: 'orange', note: 'D' },
        { name: 'Yellow', color: 'yellow', note: 'E' },
        { name: 'Green', color: 'green', note: 'F' },
        { name: 'Blue', color: 'blue', note: 'G' },
        { name: 'Purple', color: 'purple', note: 'A' },
        { name: 'Pink', color: 'pink', note: 'B' },
        { name: 'Brown', color: 'brown', note: 'C2' }
      ];
      
      // Save the notes for the song player
      musicState.notes = colors;
      
      // Create keys
      colors.forEach(colorNote => {
        const key = document.createElement('div');
        key.className = 'music-key';
        key.style.background = colorGradients[colorNote.color] || colorNote.color;
        key.setAttribute('data-note', colorNote.note);
        key.setAttribute('data-color', colorNote.color);
        key.setAttribute('data-name', colorNote.name);
        
        // Add click handler
        key.addEventListener('click', () => {
          playNote(colorNote);
        });
        
        keysContainer.appendChild(key);
      });
    }

    function playNote(colorNote) {
      // Animate the key
      const keys = document.querySelectorAll('.music-key');
      keys.forEach(key => {
        if (key.getAttribute('data-note') === colorNote.note) {
          key.classList.add('active');
          setTimeout(() => {
            key.classList.remove('active');
          }, 300);
        }
      });
      
      // Animate the instrument
      const instrument = document.getElementById('music-instrument');
      instrument.classList.add('playing');
      setTimeout(() => {
        instrument.classList.remove('playing');
      }, 300);
      
      // Play sound
      playNoteSound(colorNote.note);
      
      // Show color popup
      showColorPopup(colorNote.color, colorNote.name, 'üéµ');
      
      // Add sparkle effect around the instrument
      addMusicSparkles(colorNote.color);
    }

    function playNoteSound(note) {
      // Simple approach using audio frequencies
      if (!gameState.settings.sound) return;
      
      // Map notes to frequencies (a simple approximation of musical notes)
      const frequencies = {
        'C': 262,
        'D': 294,
        'E': 330,
        'F': 349,
        'G': 392,
        'A': 440,
        'B': 494,
        'C2': 523
      };
      
      try {
        // Create audio context
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        // Create oscillator
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        // Set instrument type
        switch(musicState.currentInstrument) {
          case 'piano':
            oscillator.type = 'sine';
            break;
          case 'guitar':
            oscillator.type = 'triangle';
            break;
          case 'drum':
            oscillator.type = 'square';
            break;
          case 'trumpet':
            oscillator.type = 'sawtooth';
            break;
          case 'violin':
            oscillator.type = 'sine';
            break;
          default:
            oscillator.type = 'sine';
        }
        
        // Set frequency based on note
        oscillator.frequency.value = frequencies[note] || 440;
        
        // Connect oscillator to gain node and gain node to output
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        // Set volume
        gainNode.gain.value = 0.3;
        
        // Start and stop the sound
        oscillator.start();
        
        // Fade out to avoid clicks
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
        
        // Stop after 1 second
        setTimeout(() => {
          oscillator.stop();
        }, 1000);
      } catch (e) {
        console.log('Audio playback failed:', e);
        // Fallback to UI sound
        playUISound('click');
      }
    }

    function changeInstrument() {
      // Get the next instrument
      const currentIndex = musicState.instruments.indexOf(musicState.currentInstrument);
      const nextIndex = (currentIndex + 1) % musicState.instruments.length;
      musicState.currentInstrument = musicState.instruments[nextIndex];
      
      // Update the display
      const instrumentDisplay = document.getElementById('music-instrument');
      
      // Add a little animation for changing
      instrumentDisplay.style.transform = 'scale(0)';
      setTimeout(() => {
        instrumentDisplay.textContent = musicState.instrumentEmojis[musicState.currentInstrument];
        instrumentDisplay.style.transform = 'scale(1)';
      }, 300);
    }

    function playSong() {
      if (musicState.isPlayingSong) {
        // Stop the song
        if (musicState.songTimeout) {
          clearTimeout(musicState.songTimeout);
          musicState.songTimeout = null;
        }
        musicState.isPlayingSong = false;
        document.getElementById('play-song').textContent = 'Play Song';
        return;
      }
      
      // Start playing the song
      musicState.isPlayingSong = true;
      document.getElementById('play-song').textContent = 'Stop Song';
      
      // Simple song pattern (twinkle twinkle little star)
      const songPattern = [0, 0, 4, 4, 5, 5, 4, 3, 3, 2, 2, 1, 1, 0];
      let noteIndex = 0;
      
      // Function to play next note in sequence
      function playNextNote() {
        if (!musicState.isPlayingSong) return;
        
        // Get the note to play
        const noteObj = musicState.notes[songPattern[noteIndex]];
        
        // Play the note
        playNote(noteObj);
        
        // Move to next note
        noteIndex = (noteIndex + 1) % songPattern.length;
        
        // Schedule next note
        musicState.songTimeout = setTimeout(playNextNote, 600);
      }
      
      // Start playing
      playNextNote();
    }

    function addMusicSparkles(color) {
      const stage = document.getElementById('music-stage');
      
      // Create sparkles around the instrument
      for (let i = 0; i < 10; i++) {
        setTimeout(() => {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle ' + 
            ['sparkle-sm', 'sparkle-md', 'sparkle-lg'][Math.floor(Math.random() * 3)];
          
          // Use the note color for sparkles
          sparkle.style.background = color;
          
          // Random position around the instrument
          sparkle.style.left = (40 + Math.random() * 20) + '%';
          sparkle.style.top = (40 + Math.random() * 20) + '%';
          
          stage.appendChild(sparkle);
          
          // Remove after animation completes
          setTimeout(() => sparkle.remove(), 1000);
        }, Math.random() * 500);
      }
    }

    // Seasons Mode Functionality
    const seasonsState = {
      currentSeason: 'spring',
      seasons: {
        spring: {
          background: 'linear-gradient(to bottom, #e1f5fe, #c1f0dc)',
          items: [
            { emoji: 'üå∏', color: 'pink', name: 'Cherry Blossom', position: { top: '20%', left: '30%' } },
            { emoji: 'üå∑', color: 'red', name: 'Tulip', position: { top: '60%', left: '20%' } },
            { emoji: 'üêù', color: 'yellow', name: 'Bee', position: { top: '40%', left: '70%' } },
            { emoji: 'ü¶ã', color: 'blue', name: 'Butterfly', position: { top: '30%', left: '50%' } }
          ]
        },
        summer: {
          background: 'linear-gradient(to bottom, #ffed9e, #ffc292)',
          items: [
            { emoji: 'üåû', color: 'yellow', name: 'Sun', position: { top: '15%', left: '75%' } },
            { emoji: 'üåä', color: 'blue', name: 'Wave', position: { top: '70%', left: '30%' } },
            { emoji: 'üç¶', color: 'white', name: 'Ice Cream', position: { top: '50%', left: '60%' } },
            { emoji: 'üçâ', color: 'red', name: 'Watermelon', position: { top: '40%', left: '20%' } }
          ]
        },
        autumn: {
          background: 'linear-gradient(to bottom, #ffe8bb, #ffc09f)',
          items: [
            { emoji: 'üçÅ', color: 'orange', name: 'Maple Leaf', position: { top: '30%', left: '40%' } },
            { emoji: 'üçÇ', color: 'brown', name: 'Falling Leaf', position: { top: '50%', left: '70%' } },
            { emoji: 'üéÉ', color: 'orange', name: 'Pumpkin', position: { top: '60%', left: '20%' } },
            { emoji: 'ü¶ä', color: 'orange', name: 'Fox', position: { top: '40%', left: '60%' } }
          ]
        },
        winter: {
          background: 'linear-gradient(to bottom, #e8f5f7, #cbe6ef)',
          items: [
            { emoji: '‚ùÑÔ∏è', color: 'white', name: 'Snowflake', position: { top: '20%', left: '60%' } },
            { emoji: '‚õÑ', color: 'white', name: 'Snowman', position: { top: '50%', left: '40%' } },
            { emoji: 'üß£', color: 'red', name: 'Scarf', position: { top: '30%', left: '20%' } },
            { emoji: 'üß§', color: 'blue', name: 'Mittens', position: { top: '60%', left: '75%' } }
          ]
        }
      }
    };

    function initializeSeasonsMode() {
      // Set up season buttons
      const seasonButtons = document.querySelectorAll('.season-btn');
      seasonButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update season
          seasonsState.currentSeason = btn.getAttribute('data-season');
          
          // Update active button
          seasonButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Render season scene
          renderSeasonScene();
          
          // Play sound
          playUISound('click');
        });
      });
      
      // Initial render
      renderSeasonScene();
    }

    function renderSeasonScene() {
      const seasonScene = document.getElementById('season-scene');
      const seasonNameElement = document.getElementById('season-name');
      
      // Get current season data
      const season = seasonsState.seasons[seasonsState.currentSeason];
      
      // Update scene background
      seasonScene.style.background = season.background;
      
      // Update season name
      seasonNameElement.textContent = seasonsState.currentSeason.charAt(0).toUpperCase() + 
                                    seasonsState.currentSeason.slice(1);
      
      // Clear previous items
      seasonScene.innerHTML = '';
      
      // Add seasonal items
      season.items.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'season-item';
        itemElement.textContent = item.emoji;
        itemElement.style.top = item.position.top;
        itemElement.style.left = item.position.left;
        itemElement.style.fontSize = '3em';
        
        // Apply subtle animation
        itemElement.style.animation = `float ${3 + Math.random() * 2}s ease-in-out infinite`;
        
        // Add data attributes
        itemElement.setAttribute('data-color', item.color);
        itemElement.setAttribute('data-name', item.name);
        
        // Add click handler
        itemElement.addEventListener('click', () => {
          interactWithSeasonItem(item);
        });
        
        seasonScene.appendChild(itemElement);
      });
      
      // If this is first time seeing this season, speak its name
      if (gameState.settings.speech) {
        speakColor(seasonNameElement.textContent + ' Season');
      }
    }

    function interactWithSeasonItem(item) {
      // Play sound
      playUISound('click');
      
      // Show color popup
      showColorPopup(item.color, item.name, item.emoji);
      
      // Speak item name
      if (gameState.settings.speech) {
        speakColor(item.name);
      }
      
      // Add confetti of the item's color
      confettiBurst(item.color);
      
      // Track interaction (for potential achievements)
      if (!gameState.userProgress.achievements.includes('season_explorer') && 
          Object.keys(seasonsState.seasons).every(season => {
            return localStorage.getItem(`visited_${season}`) === 'true';
          })) {
        gameState.userProgress.achievements.push('season_explorer');
        saveProgress();
        showAchievement('Season Explorer!');
      }
      
      // Mark this season as visited
      try {
        localStorage.setItem(`visited_${seasonsState.currentSeason}`, 'true');
      } catch (e) {
        console.log('Could not save season visit:', e);
      }
    }

    // Helper Functions
  </script>
</body>
</html> 
